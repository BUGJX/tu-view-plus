"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const o=require("vue"),he=require("./trigger.js"),Re=require("../../only-client/index.js"),U=require("../../resize-observer/index.js"),m=require("@tu-view-plus/hooks"),h=require("@tu-view-plus/utils"),H=require("./constant.js"),R=require("./utils.js");require("../style/trigger.css");const we=["onClick","onMouseenter","onMouseleave","onFocusin","onFocusout","onContextmenu"],ge=o.defineComponent({name:"TuTrigger",props:he.triggerProps,setup(n,{emit:p,slots:r,attrs:l}){const{popupContainer:X}=o.toRefs(n),Y=o.computed(()=>h.omit(l,we)),f=o.computed(()=>[].concat(n.trigger)),O=new Set,i=o.inject(H.triggerInjectionKey,void 0),{children:E,firstElement:y}=m.useFirstElement(),w=o.ref(),B=o.ref(n.defaultPopupVisible),S=o.ref(n.position),W=o.ref({}),x=o.ref({}),$=o.ref({}),J=o.ref(),s=o.ref({top:0,left:0}),u=o.computed(()=>n.popupVisible??B.value),M=m.useNamespace("popup"),{teleportContainer:Q,containerRef:k}=m.useTeleportContainer({popupContainer:X,visible:u,documentContainer:!0}),{zIndex:Z}=m.usePopupManager("popup",{visible:u});let T=0,v=!1;const ee=()=>{T&&(window.clearTimeout(T),T=0)},N=e=>{if(n.alignPoint){const{pageX:t,pageY:c}=e;s.value={top:c,left:t}}},g=()=>{if(!y.value||!w.value||!k.value)return;const e=k.value.getBoundingClientRect(),t=n.alignPoint?{top:s.value.top,bottom:s.value.top,left:s.value.left,right:s.value.left,scrollTop:s.value.top,scrollBottom:s.value.top,scrollLeft:s.value.left,scrollRight:s.value.left,width:0,height:0}:R.getElementScrollRect(y.value,e),c=()=>R.getElementScrollRect(w.value,e),F=c(),{style:C,position:V}=R.getPopupStyle(n.position,e,t,F,{offset:n.popupOffset,translate:n.popupTranslate,customStyle:n.popupStyle,autoFitPosition:n.autoFitPosition});n.autoFitTransformOrigin&&(x.value={transformOrigin:R.getTransformOrigin(V)}),n.autoFitPopupMinWidth?C.minWidth=`${t.width}px`:n.autoFitPopupWidth&&(C.width=`${t.width}px`),S.value!==V&&(S.value=V),W.value=C,n.showArrow&&o.nextTick(()=>{$.value=R.getArrowStyle(V,t,c(),{customStyle:n.arrowStyle})})},d=(e,t)=>{if(e===u.value&&T===0)return;const c=()=>{B.value=e,p("update:popupVisible",e),p("popupVisibleChange",e),e&&o.nextTick(()=>{g()})};t?(ee(),e!==u.value&&(T=window.setTimeout(c,t))):c()},ne=e=>{var t;(t=l.onClick)==null||t.call(l,e),!(n.disabled||u.value&&!n.clickToClose)&&(f.value.includes("click")?(N(e),d(!u.value)):f.value.includes("contextMenu")&&u.value&&d(!1))},I=e=>{var t;(t=l.onMouseenter)==null||t.call(l,e),!(n.disabled||!f.value.includes("hover"))&&(N(e),d(!0,n.mouseEnterDelay))},_=e=>{i==null||i.onMouseenter(e),I(e)},j=e=>{var t;(t=l.onMouseleave)==null||t.call(l,e),!(n.disabled||!f.value.includes("hover"))&&d(!1,n.mouseLeaveDelay)},G=e=>{i==null||i.onMouseleave(e),j(e)},oe=e=>{var t;(t=l.onFocusin)==null||t.call(l,e),!(n.disabled||!f.value.includes("focus"))&&d(!0,n.focusDelay)},te=e=>{var t;(t=l.onFocusout)==null||t.call(l,e),!(n.disabled||!f.value.includes("focus"))&&n.blurToClose&&d(!1)},ue=e=>{var t;(t=l.onContextmenu)==null||t.call(l,e),!(n.disabled||!f.value.includes("contextMenu")||u.value&&!n.clickToClose)&&(N(e),d(!u.value),e.preventDefault())},le=e=>{O.add(e),i==null||i.addChildRef(e)},ie=e=>{O.delete(e),i==null||i.removeChildRef(e)};o.provide(H.triggerInjectionKey,o.reactive({onMouseenter:_,onMouseleave:G,addChildRef:le,removeChildRef:ie}));const z=()=>{h.off(document.documentElement,"mousedown",A),v=!1},L=m.usePickSlots(r,"content"),ae=o.computed(()=>{var e;return n.hideEmpty&&h.isEmptyChildren((e=L.value)==null?void 0:e.call(L))}),A=e=>{var t,c,F;if(!((t=y.value)!=null&&t.contains(e.target)||(c=w.value)!=null&&c.contains(e.target))){for(const C of O)if((F=C.value)!=null&&F.contains(e.target))return;z(),d(!1)}},P=h.throttleByRaf(()=>{u.value&&g()}),q=()=>{u.value&&g()},ce=()=>{q(),p("resize")},se=e=>{n.preventFocus&&e.preventDefault()};i==null||i.addChildRef(w);const de=o.computed(()=>u.value?n.openedClass:void 0);let a;o.watch(u,e=>{if(n.clickOutsideToClose&&(!e&&v?z():e&&!v&&(h.on(document.documentElement,"mousedown",A),v=!0)),n.updateAtScroll){if(e){a=R.getScrollElements(y.value);for(const t of a)t.addEventListener("scroll",P)}else if(a){for(const t of a)t.removeEventListener("scroll",P);a=void 0}}e&&(D.value=!0)}),o.watch(()=>[n.autoFitPopupWidth,n.autoFitPopupMinWidth],()=>{u.value&&g()});const{createResizeObserver:re,destroyResizeObserver:fe}=m.useResizeObserver({elementRef:k,onResize:q});o.onMounted(()=>{if(re(),u.value&&(g(),n.clickOutsideToClose&&!v&&(h.on(document.documentElement,"mousedown",A),v=!0),n.updateAtScroll)){a=R.getScrollElements(y.value);for(const e of a)e.addEventListener("scroll",P)}}),o.onUpdated(()=>{u.value&&g()}),o.onDeactivated(()=>{d(!1)}),o.onBeforeUnmount(()=>{if(i==null||i.removeChildRef(w),fe(),v&&z(),a){for(const e of a)e.removeEventListener("scroll",P);a=void 0}});const D=o.ref(u.value),b=o.ref(!1),K=()=>{b.value=!0},ve=()=>{b.value=!1,u.value&&p("show")},me=()=>{b.value=!1,u.value||(D.value=!1,p("hide"))};return()=>{var e;return E.value=((e=r.default)==null?void 0:e.call(r))??[],h.mergeFirstChild(E.value,{class:de.value,onClick:ne,onMouseenter:I,onMouseleave:j,onFocusin:oe,onFocusout:te,onContextmenu:ue}),o.createVNode(o.Fragment,null,[n.autoFixPosition?o.createVNode(U.TuResizeObserver,{onResize:ce},{default:()=>[E.value]}):E.value,o.createVNode(Re.TuOnlyClient,null,{default:()=>[o.createVNode(o.Teleport,{to:Q.value,disabled:!n.renderToBody},{default:()=>[(!n.unmountOnClose||u.value||D.value)&&!ae.value&&o.createVNode(U.TuResizeObserver,{onResize:q},{default:()=>[o.createVNode("div",o.mergeProps({ref:w,class:[M.b(),M.m(S.value)],style:{...W.value,zIndex:Z.value,pointerEvents:b.value?"none":"auto"},"trigger-placement":S.value,onMouseenter:_,onMouseleave:G,onMousedown:se},Y.value),[o.createVNode(o.Transition,{name:`${m.defaultNamespace}-${n.animationName}`,duration:n.duration,appear:!0,onBeforeEnter:K,onAfterEnter:ve,onBeforeLeave:K,onAfterLeave:me},{default:()=>{var t;return[o.withDirectives(o.createVNode("div",{class:M.e("wrapper"),style:x.value},[o.createVNode("div",{class:[M.e("content"),n.contentClass],style:n.contentStyle},[(t=r.content)==null?void 0:t.call(r)]),n.showArrow&&o.createVNode("div",{ref:J,class:[M.e("arrow"),n.arrowClass],style:$.value},null)]),[[o.vShow,u.value]])]}})])]})]})]})])}}});exports.default=ge;
