"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const u=require("vue"),j=require("./select.js"),A=require("@tu-view-plus/hooks"),i=require("@tu-view-plus/utils"),ge=require("./use-select.js");require("../../form/index.js");const V=require("./utils.js"),me=require("../../trigger/index.js"),be=require("./select-dropdown.vue.js"),pe=require("./select-group.vue.js"),he=require("./select-option.vue.js"),Ve=require("../../virtual-list/index.js"),we=require("../../select-view/index.js");require("../style/select.css");const B=require("../../form/src/hooks/use-form-props.js");function ye(l){return typeof l=="function"||Object.prototype.toString.call(l)==="[object Object]"&&!u.isVNode(l)}const Oe={value:"value",label:"label",disabled:"disabled",tagProps:"tagProps",render:"render"},_e=u.defineComponent({name:"TuSelect",props:j.selectProps,emits:j.selectEmits,inheritAttrs:!1,setup(l,{slots:r,emit:c,attrs:M}){const{options:$,filterOption:w,valueKey:f,multiple:k,popupVisible:z,showExtraOptions:U,modelValue:G,fieldNames:y,loading:H,defaultActiveFirstOption:W}=u.toRefs(l),x=A.useNamespace("select"),q=u.ref(),E=u.ref({}),D=u.ref(),S=u.ref(l.defaultValue),g=u.ref([]),T=u.ref(),L=u.ref(""),N=B.useFormDisabled(),C=B.useFormSize(),J=u.computed(()=>({[x.b()]:!0,[x.m(C.value)]:!0})),F=u.computed(()=>i.isObject(l.allowSearch)&&!!l.allowSearch.retainInputValue),R=u.computed(()=>({...Oe,...y==null?void 0:y.value})),Q=u.computed(()=>l.virtualListProps?"div":"li"),d=u.computed(()=>l.inputValue??L.value),v=u.computed(()=>P.value.map(e=>e.key)),X=u.computed(()=>g.value.map(e=>{var a;let n=Z(e.value);const t=(a=T.value)==null?void 0:a[e.key];return!i.isUndefined(t)&&!i.isEmptyObject(t)&&(n={...n,...t}),n})),P=u.computed(()=>{const e=l.modelValue??S.value;return(i.isArray(e)?e:e||i.isNumber(e)||i.isString(e)||i.isBoolean(e)?[e]:[]).map(t=>({value:t,key:V.getKeyFromValue(t,l.valueKey)}))}),Y=u.computed(()=>{const e=[];for(const n of P.value){const t=o.get(n.key);t&&e.push({...t,value:n.key,label:(t==null?void 0:t.label)??String(i.isObject(n.value)?n.value[f==null?void 0:f.value]:n.value),closable:!(t!=null&&t.disabled)})}return e}),Z=e=>i.isFunction(l.fallbackOption)?l.fallbackOption(e):{[R.value.value]:e,[R.value.label]:String(i.isObject(e)?e[f==null?void 0:f.value]:e)},I=e=>{var n;return l.multiple?e.map(t=>{var a;return((a=o.get(t))==null?void 0:a.value)??""}):((n=o.get(e[0]))==null?void 0:n.value)??(V.hasEmptyStringKey(o)?void 0:"")},ee=e=>{const n={};return e.forEach(t=>{n[t]=o.get(t)}),n},te=e=>{T.value=ee(e)},m=e=>{const n=I(e);S.value=n,c("update:modelValue",n),c("change",n),te(e)},b=e=>{L.value=e,c("update:inputValue",e),c("inputValueChange",e)},le=()=>{const e=[],n=[];if(l.allowCreate||l.fallbackOption){for(const t of P.value)if(!n.includes(t.key)&&t.value!==""){const a=o.get(t.key);(!a||a.origin==="extraOptions")&&(e.push(t),n.push(t.key))}}if(l.allowCreate&&d.value){const t=V.getKeyFromValue(d.value);if(!n.includes(t)){const a=o.get(t);(!a||a.origin==="extraOptions")&&e.push({value:d.value,key:t})}}return e},ae=e=>{if(i.isFunction(r.option)){const n=r.option;return()=>n({data:e.raw})}return i.isFunction(e.render)?e.render:()=>e.label},ne=(e,n)=>{if(l.multiple){if(v.value.includes(e)){const t=v.value.filter(a=>a!==e);m(t)}else if(ve.value.includes(e))if(l.limit>0&&v.value.length>=l.limit){const t=o.get(e);c("exceedLimit",t==null?void 0:t.value,n)}else{const t=v.value.concat(e);m(t)}F.value||b("")}else{if(e!==v.value[0]&&m([e]),F.value){const t=o.get(e);t&&b(t.label)}O(!1)}},ue=i.debounce(e=>{c("search",e)},l.searchDelay),re=e=>{e!==d.value&&(p.value||O(!0),b(e),l.allowSearch&&ue(e))},ie=e=>{const n=o.get(e),t=v.value.filter(a=>a!==e);m(t),c("remove",n==null?void 0:n.value)},oe=e=>{e==null||e.stopPropagation();const n=v.value.filter(t=>{var a;return(a=o.get(t))==null?void 0:a.disabled});m(n),b(""),c("clear",e)},ce=e=>{c("dropdownScroll",e)},se=e=>{c("dropdownReachBottom",e)},{computedPopupVisible:p,handlePopupVisibleChange:O}=A.useTrigger({popupVisible:z,emit:c}),{validOptions:K,optionInfoMap:o,validOptionInfos:de,enabledOptionKeys:ve,handleKeyDown:fe}=ge.useSelect({selectSize:C,multiple:k,options:$,extraOptions:X,inputValue:d,filterOption:w,showExtraOptions:U,component:Q,valueKey:f,fieldNames:y,loading:H,popupVisible:p,valueKeys:v,dropdownRef:q,optionRefs:E,virtualListRef:D,defaultActiveFirstOption:W,onSelect:ne,onPopupVisibleChange:O});return u.watch(G,e=>{(i.isUndefined(e)||i.isNull(e))&&(S.value=k.value?[]:e)}),u.watch(p,e=>{!e&&!F.value&&d.value&&b("")}),u.nextTick(()=>{u.watchEffect(()=>{var n;const e=le();if(e.length!==g.value.length)g.value=e;else if(e.length>0){for(let t=0;t<e.length;t++)if(e[t].key!==((n=g.value[t])==null?void 0:n.key)){g.value=e;break}}})}),()=>{const e=({data:a})=>{var s,_;if((r.label||i.isFunction(l.formatLabel))&&a){const h=o.get(a.value);if(h!=null&&h.raw)return((s=r.label)==null?void 0:s.call(r,{data:h.raw}))??((_=l.formatLabel)==null?void 0:_.call(l,h.raw))}return(a==null?void 0:a.label)??""},n=a=>{if(V.isGroupOptionInfo(a)){let s;return u.createVNode(pe.default,{key:a.key,label:a.label},ye(s=a.options.map(_=>n(_)))?s:{default:()=>[s]})}return V.isValidOption(a,{inputValue:d.value,filterOption:w==null?void 0:w.value})?u.createVNode(he.default,{ref:s=>{s!=null&&s.$el&&(E.value[a.key]=s.$el)},key:a.key,value:a.value,label:a.label,disabled:a.disabled,internal:!0},{default:ae(a)}):null},t=()=>u.createVNode(be.default,{ref:q,loading:l.loading,empty:de.value.length===0,virtualList:!!l.virtualListProps,scrollbar:l.scrollbar,showHeaderOnEmpty:l.showHeaderOnEmpty,showFooterOnEmpty:l.showFooterOnEmpty,onScroll:ce,onReachBottom:se},{default:()=>{var a;return[...((a=r.default)==null?void 0:a.call(r))??[],...K.value.map(n)]},"virtual-list":()=>u.createVNode(Ve.TuVirtualList,u.mergeProps(l.virtualListProps,{ref:D,data:K.value}),{item:({item:a})=>n(a)}),empty:r.empty,header:r.header,footer:r.footer});return u.createVNode(me.TuTrigger,u.mergeProps({trigger:"click",position:"bl",popupOffset:10,animationName:"slide-dynamic-origin",hideEmpty:!0,preventFocus:!0,autoFitPopupWidth:!0,autoFitTransformOrigin:!0,disabled:N.value,popupVisible:p.value,unmountOnClose:l.unmountOnClose,clickToClose:!(l.allowSearch||l.allowCreate),popupContainer:l.popupContainer,onPopupVisibleChange:O},l.triggerProps),{default:()=>{var a;return[((a=r.trigger)==null?void 0:a.call(r))??u.createVNode(we.TuSelectView,u.mergeProps({class:J.value,modelValue:Y.value,inputValue:d.value,multiple:l.multiple,disabled:N.value,loading:l.loading,allowClear:l.allowClear,allowCreate:l.allowCreate,allowSearch:!!l.allowSearch,opened:p.value,maxTagCount:l.maxTagCount,placeholder:l.placeholder,bordered:l.bordered,size:C.value,onInputValueChange:re,onRemove:ie,onClear:oe,onKeydown:fe},M),{label:e,prefix:r.prefix,"arrow-icon":r["arrow-icon"],"loading-icon":r["loading-icon"],"search-icon":r["search-icon"]})]},content:t})}}});exports.default=_e;
