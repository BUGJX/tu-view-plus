"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const u=require("vue"),A=require("./select.js"),B=require("@tu-view-plus/hooks"),i=require("@tu-view-plus/utils"),me=require("./use-select.js");require("../../form/index.js");const V=require("./utils.js"),be=require("../../trigger/index.js"),he=require("./select-dropdown.vue.js"),pe=require("./select-group.vue.js"),Ve=require("./select-option.vue.js"),we=require("../../virtual-list/index.js"),ye=require("../../select-view/index.js");require("../style/select.css");const Oe=require("../../form/src/hooks/use-form-item.js"),M=require("../../form/src/hooks/use-form-props.js");function _e(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!u.isVNode(a)}const Se={value:"value",label:"label",disabled:"disabled",tagProps:"tagProps",render:"render"},Ce=u.defineComponent({name:"TuSelect",props:A.selectProps,emits:A.selectEmits,inheritAttrs:!1,setup(a,{slots:r,emit:c,attrs:$}){const{options:z,filterOption:w,valueKey:f,multiple:q,popupVisible:U,showExtraOptions:G,modelValue:H,fieldNames:y,loading:W,defaultActiveFirstOption:J}=u.toRefs(a),x=B.useNamespace("select"),{formItem:S}=Oe.useFormItem(),E=u.ref(),D=u.ref({}),T=u.ref(),C=u.ref(a.defaultValue),g=u.ref([]),L=u.ref(),N=u.ref(""),R=M.useFormDisabled(),F=M.useFormSize(),Q=u.computed(()=>({[x.b()]:!0,[x.m(F.value)]:!0})),P=u.computed(()=>i.isObject(a.allowSearch)&&!!a.allowSearch.retainInputValue),K=u.computed(()=>({...Se,...y==null?void 0:y.value})),X=u.computed(()=>a.virtualListProps?"div":"li"),d=u.computed(()=>a.inputValue??N.value),v=u.computed(()=>k.value.map(e=>e.key)),Y=u.computed(()=>g.value.map(e=>{var l;let n=I(e.value);const t=(l=L.value)==null?void 0:l[e.key];return!i.isUndefined(t)&&!i.isEmptyObject(t)&&(n={...n,...t}),n})),k=u.computed(()=>{const e=a.modelValue??C.value;return(i.isArray(e)?e:e||i.isNumber(e)||i.isString(e)||i.isBoolean(e)?[e]:[]).map(t=>({value:t,key:V.getKeyFromValue(t,a.valueKey)}))}),Z=u.computed(()=>{const e=[];for(const n of k.value){const t=o.get(n.key);t&&e.push({...t,value:n.key,label:(t==null?void 0:t.label)??String(i.isObject(n.value)?n.value[f==null?void 0:f.value]:n.value),closable:!(t!=null&&t.disabled)})}return e}),I=e=>i.isFunction(a.fallbackOption)?a.fallbackOption(e):{[K.value.value]:e,[K.value.label]:String(i.isObject(e)?e[f==null?void 0:f.value]:e)},ee=e=>{var n;return a.multiple?e.map(t=>{var l;return((l=o.get(t))==null?void 0:l.value)??""}):((n=o.get(e[0]))==null?void 0:n.value)??(V.hasEmptyStringKey(o)?void 0:"")},te=e=>{const n={};return e.forEach(t=>{n[t]=o.get(t)}),n},ae=e=>{L.value=te(e)},m=e=>{const n=ee(e);C.value=n,c("update:modelValue",n),c("change",n),S==null||S.validate("change").catch(t=>i.debugWarn(t)),ae(e)},b=e=>{N.value=e,c("update:inputValue",e),c("inputValueChange",e)},le=()=>{const e=[],n=[];if(a.allowCreate||a.fallbackOption){for(const t of k.value)if(!n.includes(t.key)&&t.value!==""){const l=o.get(t.key);(!l||l.origin==="extraOptions")&&(e.push(t),n.push(t.key))}}if(a.allowCreate&&d.value){const t=V.getKeyFromValue(d.value);if(!n.includes(t)){const l=o.get(t);(!l||l.origin==="extraOptions")&&e.push({value:d.value,key:t})}}return e},ne=e=>{if(i.isFunction(r.option)){const n=r.option;return()=>n({data:e.raw})}return i.isFunction(e.render)?e.render:()=>e.label},ue=(e,n)=>{if(a.multiple){if(v.value.includes(e)){const t=v.value.filter(l=>l!==e);m(t)}else if(fe.value.includes(e))if(a.limit>0&&v.value.length>=a.limit){const t=o.get(e);c("exceedLimit",t==null?void 0:t.value,n)}else{const t=v.value.concat(e);m(t)}P.value||b("")}else{if(e!==v.value[0]&&m([e]),P.value){const t=o.get(e);t&&b(t.label)}O(!1)}},re=i.debounce(e=>{c("search",e)},a.searchDelay),ie=e=>{e!==d.value&&(h.value||O(!0),b(e),a.allowSearch&&re(e))},oe=e=>{const n=o.get(e),t=v.value.filter(l=>l!==e);m(t),c("remove",n==null?void 0:n.value)},ce=e=>{e==null||e.stopPropagation();const n=v.value.filter(t=>{var l;return(l=o.get(t))==null?void 0:l.disabled});m(n),b(""),c("clear",e)},se=e=>{c("dropdownScroll",e)},de=e=>{c("dropdownReachBottom",e)},{computedPopupVisible:h,handlePopupVisibleChange:O}=B.useTrigger({popupVisible:U,emit:c}),{validOptions:j,optionInfoMap:o,validOptionInfos:ve,enabledOptionKeys:fe,handleKeyDown:ge}=me.useSelect({selectSize:F,multiple:q,options:z,extraOptions:Y,inputValue:d,filterOption:w,showExtraOptions:G,component:X,valueKey:f,fieldNames:y,loading:W,popupVisible:h,valueKeys:v,dropdownRef:E,optionRefs:D,virtualListRef:T,defaultActiveFirstOption:J,onSelect:ue,onPopupVisibleChange:O});return u.watch(H,e=>{(i.isUndefined(e)||i.isNull(e))&&(C.value=q.value?[]:e)}),u.watch(h,e=>{!e&&!P.value&&d.value&&b("")}),u.nextTick(()=>{u.watchEffect(()=>{var n;const e=le();if(e.length!==g.value.length)g.value=e;else if(e.length>0){for(let t=0;t<e.length;t++)if(e[t].key!==((n=g.value[t])==null?void 0:n.key)){g.value=e;break}}})}),()=>{const e=({data:l})=>{var s,_;if((r.label||i.isFunction(a.formatLabel))&&l){const p=o.get(l.value);if(p!=null&&p.raw)return((s=r.label)==null?void 0:s.call(r,{data:p.raw}))??((_=a.formatLabel)==null?void 0:_.call(a,p.raw))}return(l==null?void 0:l.label)??""},n=l=>{if(V.isGroupOptionInfo(l)){let s;return u.createVNode(pe.default,{key:l.key,label:l.label},_e(s=l.options.map(_=>n(_)))?s:{default:()=>[s]})}return V.isValidOption(l,{inputValue:d.value,filterOption:w==null?void 0:w.value})?u.createVNode(Ve.default,{ref:s=>{s!=null&&s.$el&&(D.value[l.key]=s.$el)},key:l.key,value:l.value,label:l.label,disabled:l.disabled,internal:!0},{default:ne(l)}):null},t=()=>u.createVNode(he.default,{ref:E,loading:a.loading,empty:ve.value.length===0,virtualList:!!a.virtualListProps,scrollbar:a.scrollbar,showHeaderOnEmpty:a.showHeaderOnEmpty,showFooterOnEmpty:a.showFooterOnEmpty,onScroll:se,onReachBottom:de},{default:()=>{var l;return[...((l=r.default)==null?void 0:l.call(r))??[],...j.value.map(n)]},"virtual-list":()=>u.createVNode(we.TuVirtualList,u.mergeProps(a.virtualListProps,{ref:T,data:j.value}),{item:({item:l})=>n(l)}),empty:r.empty,header:r.header,footer:r.footer});return u.createVNode(be.TuTrigger,u.mergeProps({trigger:"click",position:"bl",popupOffset:8,animationName:"slide-dynamic-origin",hideEmpty:!0,preventFocus:!0,autoFitPopupWidth:!0,autoFitTransformOrigin:!0,disabled:R.value,popupVisible:h.value,unmountOnClose:a.unmountOnClose,clickToClose:!(a.allowSearch||a.allowCreate),popupContainer:a.popupContainer,onPopupVisibleChange:O},a.triggerProps),{default:()=>{var l;return[((l=r.trigger)==null?void 0:l.call(r))??u.createVNode(ye.TuSelectView,u.mergeProps({class:Q.value,modelValue:Z.value,inputValue:d.value,multiple:a.multiple,disabled:R.value,loading:a.loading,allowClear:a.allowClear,allowCreate:a.allowCreate,allowSearch:!!a.allowSearch,opened:h.value,maxTagCount:a.maxTagCount,placeholder:a.placeholder,bordered:a.bordered,size:F.value,onInputValueChange:ie,onRemove:oe,onClear:ce,onKeydown:ge},$),{label:e,prefix:r.prefix,"arrow-icon":r["arrow-icon"],"loading-icon":r["loading-icon"],"search-icon":r["search-icon"]})]},content:t})}}});exports.default=Ce;
