"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),R=require("./modal.js"),le=require("../../only-client/index.js"),r=require("@tu-view-plus/hooks"),t=require("@tu-view-plus/utils"),te=require("@tu-view-plus/icons-vue"),q=require("../../button/index.js"),A=require("../../icon/index.js");require("../style/modal.css");const ne=["onClick","onMousedown"],ae=e.defineComponent({name:"TuModal",inheritAttrs:!1}),se=e.defineComponent({...ae,props:R.modalProps,emits:R.modalEmits,setup(K,{emit:I}){let C=0,k=!1;const l=K,i=I,{t:h}=r.useLocale(),n=r.useNamespace("modal"),N=r.useNamespace("modal-container"),y=r.useNamespace("modal-wrapper"),{fullscreen:G,popupContainer:U}=e.toRefs(l),m=e.ref(),T=e.ref(),f=e.ref(l.defaultVisible),w=e.ref(!1),d=e.ref(!1),a=e.computed(()=>l.visible??f.value),F=e.computed(()=>l.okLoading||d.value),z=e.computed(()=>t.TypeComponentsMap[l.messageType]||""),p=e.ref(a.value),g=e.computed(()=>l.draggable&&!l.fullscreen),{teleportContainer:H,containerRef:E}=r.useTeleportContainer({popupContainer:U,visible:a}),{zIndex:Y,isLastDialog:j}=r.usePopupManager("dialog",{visible:a}),{position:u,handleMoveDown:V}=r.useDraggable({wrapperRef:m,modalRef:T,draggable:g}),{setOverflowHidden:M,resetOverflow:S}=r.useOverflow(E),W=e.computed(()=>({[y.b()]:!0,[y.is("align-center")]:l.alignCenter&&!l.fullscreen,[y.is("moved")]:!!u.value})),J=e.computed(()=>{const o=l.messageType;return{[n.em("icon",o)]:o&&t.TypeComponentsMap[o]}}),Q=e.computed(()=>[n.b(),l.modalClass,{[n.m(l.size)]:l.size,[n.m("simple")]:l.simple,[n.m("draggable")]:g.value,[n.m("fullscreen")]:l.fullscreen}]),X=e.computed(()=>{const o={...l.modalStyle??{}};return l.width&&(o.width=t.addUnit(l.width)),!l.alignCenter&&l.top&&(o.top=t.addUnit(l.top)),u.value&&(o.transform=`translate(${u.value[0]}px, ${u.value[1]}px)`),o}),Z=o=>{l.mask&&l.maskClosable&&w.value&&v(o)},x=o=>{o.target===m.value&&(w.value=!0)},_=async o=>{const c=C,B=await new Promise(async b=>{if(t.isFunction(l.onBeforeOk)){let s=l.onBeforeOk((L=!0)=>b(L));if((t.isPromise(s)||!t.isBoolean(s))&&(d.value=!0),t.isPromise(s))try{s=await s??!0}catch{s=!1}t.isBoolean(s)&&b(s)}else b(!0)});c===C&&(B?(i("ok",o),D()):d.value&&(d.value=!1))},v=o=>{let c=!0;t.isFunction(l.onBeforeCancel)&&(c=l.onBeforeCancel()??!1),c&&(i("cancel",o),D())},D=()=>{C++,d.value&&(d.value=!1),f.value=!1,i("update:visible",!1)},ee=()=>{a.value&&(!t.contains(m.value,document.activeElement)&&document.activeElement instanceof HTMLElement&&document.activeElement.blur(),i("open"))},oe=()=>{a.value||(g.value&&(u.value=void 0),p.value=!1,S(),i("close"))},O=()=>{l.escToClose&&!k&&(k=!0,t.on(document.documentElement,"keydown",$))},P=()=>{k=!1,t.off(document.documentElement,"keydown",$)},$=o=>{l.escToClose&&o.key===t.KEYBOARD_KEY.ESC&&j()&&v(o)};return e.watch(G,()=>{u.value&&(u.value=void 0)}),e.watch(a,o=>{f.value!==o&&(f.value=o),o?(i("beforeOpen"),p.value=!0,w.value=!1,M(),O()):(i("beforeClose"),P())}),e.onBeforeUnmount(()=>{S(),P()}),e.onMounted(()=>{E.value=t.getElement(l.popupContainer),a.value&&(M(),l.escToClose&&O())}),(o,c)=>(e.openBlock(),e.createBlock(e.unref(le.TuOnlyClient),null,{default:e.withCtx(()=>[(e.openBlock(),e.createBlock(e.Teleport,{to:e.unref(H),disabled:!o.renderToBody},[!o.unmountOnClose||a.value||p.value?e.withDirectives((e.openBlock(),e.createElementBlock("div",e.mergeProps({key:0,class:e.unref(N).b(),style:{zIndex:e.unref(Y)}},o.$attrs),[e.createVNode(e.Transition,{name:o.maskAnimationName,appear:""},{default:e.withCtx(()=>[o.mask?e.withDirectives((e.openBlock(),e.createElementBlock("div",{key:0,ref:"maskRef",class:e.normalizeClass(e.unref(N).e("mask")),style:e.normalizeStyle(o.maskStyle)},null,6)),[[e.vShow,a.value]]):e.createCommentVNode("",!0)]),_:1},8,["name"]),e.createElementVNode("div",{ref_key:"wrapperRef",ref:m,class:e.normalizeClass(W.value),onClick:e.withModifiers(Z,["self"]),onMousedown:e.withModifiers(x,["self"])},[e.createVNode(e.Transition,{appear:"",name:o.modalAnimationName,onAfterEnter:ee,onAfterLeave:oe},{default:e.withCtx(()=>[e.withDirectives(e.createElementVNode("div",{ref_key:"modalRef",ref:T,class:e.normalizeClass(Q.value),style:e.normalizeStyle(X.value)},[o.$slots.title||o.title||o.closable?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(n).e("header")),onMousedown:c[0]||(c[0]=(...B)=>e.unref(V)&&e.unref(V)(...B))},[o.$slots.title||o.title?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass([e.unref(n).e("title"),e.unref(n).is(`align-${o.titleAlign}`)])},[o.messageType?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(n).e("title-icon"))},[z.value?(e.openBlock(),e.createBlock(e.unref(A.TuIcon),{key:0,class:e.normalizeClass([e.unref(n).e("icon"),J.value])},{default:e.withCtx(()=>[(e.openBlock(),e.createBlock(e.resolveDynamicComponent(z.value)))]),_:1},8,["class"])):e.createCommentVNode("",!0)],2)):e.createCommentVNode("",!0),e.renderSlot(o.$slots,"title",{},()=>[e.createTextVNode(e.toDisplayString(o.title),1)])],2)):e.createCommentVNode("",!0),!o.simple&&o.closable?(e.openBlock(),e.createElementBlock("div",{key:1,tabindex:"-1",role:"button","aria-label":"Close",class:e.normalizeClass(e.unref(n).e("icon-close")),onClick:v},[e.createVNode(e.unref(A.TuIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(te.Close))]),_:1})],2)):e.createCommentVNode("",!0)],34)):e.createCommentVNode("",!0),e.createElementVNode("div",{class:e.normalizeClass([e.unref(n).e("body"),o.bodyClass]),style:e.normalizeStyle(o.bodyStyle)},[e.renderSlot(o.$slots,"default")],6),o.footer?(e.openBlock(),e.createElementBlock("div",{key:1,class:e.normalizeClass(e.unref(n).e("footer"))},[e.renderSlot(o.$slots,"footer",{},()=>[o.hideCancel?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(e.unref(q.TuButton),e.mergeProps({key:0},o.cancelButtonProps,{size:o.size,onClick:v}),{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(o.cancelText||e.unref(h)("tu.modal.cancel")),1)]),_:1},16,["size"])),e.createVNode(e.unref(q.TuButton),e.mergeProps({type:"primary"},o.okButtonProps,{size:o.size,loading:F.value,onClick:_}),{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(o.okText||e.unref(h)("tu.modal.confirm")),1)]),_:1},16,["size","loading"])])],2)):e.createCommentVNode("",!0)],6),[[e.vShow,a.value]])]),_:3},8,["name"])],42,ne)],16)),[[e.vShow,a.value||p.value]]):e.createCommentVNode("",!0)],8,["to","disabled"]))]),_:3}))}});exports.default=se;
