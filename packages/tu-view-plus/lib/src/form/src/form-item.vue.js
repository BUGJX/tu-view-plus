"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),te=require("async-validator"),re=require("@vueuse/core"),se=require("./form-item.js"),j=require("lodash-unified"),_=require("./constants.js"),w=require("@tu-view-plus/hooks"),o=require("@tu-view-plus/utils"),ie=require("./hooks/use-form-props.js"),le=require("./form-label-wrap.js");require("../style/form.css");const ue=["role","aria-labelledby"],ae=e.defineComponent({name:"TuFormItem"}),oe=e.defineComponent({...ae,props:se.formItemProps,setup(A,{expose:B}){const i=A,F=e.useSlots(),t=e.inject(_.formContextKey,void 0),D=e.inject(_.formItemContextKey,void 0),f=ie.useFormSize(void 0,{formItem:!1}),a=w.useNamespace("form"),g=w.useId().value,d=e.ref([]),c=e.ref(""),E=re.refDebounced(c,100),p=e.ref(""),z=e.ref();let N,h=!1;const T=!!D,P=e.computed(()=>{const r=t==null?void 0:t.model;if(!(!r||!i.prop))return o.getProp(r,i.prop).value}),y=e.computed(()=>{const{required:r}=i,s=[];i.rules&&s.push(...o.ensureArray(i.rules));const l=t==null?void 0:t.rules;if(l&&i.prop){const u=o.getProp(l,i.prop).value;u&&s.push(...o.ensureArray(u))}if(r!==void 0){const u=s.map((n,m)=>[n,m]).filter(([n])=>Object.keys(n).includes("required"));if(u.length>0)for(const[n,m]of u)n.required!==r&&(s[m]={...n,required:r});else s.push({required:r})}return s}),L=e.computed(()=>y.value.length>0),M=e.computed(()=>`${i.label||""}${(t==null?void 0:t.labelSuffix)||""}`),U=e.computed(()=>y.value.some(r=>r.required)),K=e.computed(()=>E.value==="error"&&i.showMessage&&((t==null?void 0:t.showMessage)??!0)),S=e.computed(()=>!!(i.label||F.label)),q=e.computed(()=>i.for||d.value.length===1?d.value[0]:void 0),b=e.computed(()=>!q.value&&S.value),G=e.computed(()=>i.prop?o.isString(i.prop)?i.prop:i.prop.join("."):""),O=e.computed(()=>o.isBoolean(i.inlineMessage)?i.inlineMessage:(t==null?void 0:t.inlineMessage)||!1),R=e.computed(()=>{if((t==null?void 0:t.labelPosition)==="top")return{};const r=o.addUnit(i.labelWidth||(t==null?void 0:t.labelWidth)||"");return r?{width:r}:{}}),H=e.computed(()=>{if((t==null?void 0:t.labelPosition)==="top"||t!=null&&t.inline)return{};if(!i.label&&!i.labelWidth&&T)return{};const r=o.addUnit(i.labelWidth||(t==null?void 0:t.labelWidth)||"");return!i.label&&!F.label?{marginLeft:r}:{}}),J=e.computed(()=>(t==null?void 0:t.requireAsteriskPosition)==="right"?"asterisk-right":"asterisk-left"),Q=e.computed(()=>({[a.e("item")]:!0,[a.em("item",f.value)]:f.value,[a.em("item",J.value)]:!0,[a.em("item","feedback")]:t==null?void 0:t.statusIcon,[a.is("error")]:c.value==="error",[a.is("validating")]:c.value==="validating",[a.is("success")]:c.value==="success",[a.is("required")]:U.value||i.required,[a.is("no-asterisk")]:t==null?void 0:t.hideRequiredAsterisk})),X=e.computed(()=>({[a.e("item-error")]:!0,[a.em("item-error","inline")]:O.value})),Y=r=>y.value.filter(l=>!l.trigger||!r?!0:Array.isArray(l.trigger)?l.trigger.includes(r):l.trigger===r).map(({trigger:l,...u})=>u),v=r=>{c.value=r},Z=r=>{var u;const{errors:s,fields:l}=r;(!s||!l)&&console.error(r),v("error"),p.value=s?((u=s==null?void 0:s[0])==null?void 0:u.message)??`${i.prop} is required`:"",t==null||t.emit("validate",i.prop,!1,p.value)},k=()=>{v("success"),t==null||t.emit("validate",i.prop,!0,"")},C=async r=>{const s=G.value;return new te({[s]:r}).validate({[s]:P.value},{firstFields:!0}).then(()=>(k(),!0)).catch(u=>(Z(u),Promise.reject(u)))},W=async(r,s)=>{if(h||!i.prop)return!1;const l=o.isFunction(s);if(!L.value)return s==null||s(!1),!1;const u=Y(r);return u.length===0?(s==null||s(!0),!0):(v("validating"),C(u).then(()=>(s==null||s(!0),!0)).catch(n=>{const{fields:m}=n;return s==null||s(!1,m),l?!1:Promise.reject(m)}))},I=()=>{v(""),p.value="",h=!1},$=async()=>{const r=t==null?void 0:t.model;if(!r||!i.prop)return;const s=o.getProp(r,i.prop);h=!0,s.value=j.clone(N),await e.nextTick(),I(),h=!1},x=r=>{d.value.includes(r)||d.value.push(r)},ee=r=>{d.value=d.value.filter(s=>s!==r)};e.watch(()=>i.error,r=>{p.value=r||"",v(r?"error":"")},{immediate:!0}),e.watch(()=>i.validateStatus,r=>v(r||""));const V=e.reactive({...e.toRefs(i),$el:z,size:f,validateState:c,labelId:g,inputIds:d,isGroup:b,hasLabel:S,addInputId:x,removeInputId:ee,resetField:$,clearValidate:I,validate:W});return e.provide(_.formItemContextKey,V),e.onMounted(()=>{i.prop&&(t==null||t.addField(V),N=j.clone(P.value))}),e.onBeforeUnmount(()=>{t==null||t.removeField(V)}),B({size:f,validateMessage:p,validateState:c,validate:W,clearValidate:I,resetField:$}),(r,s)=>{var l;return e.openBlock(),e.createElementBlock("div",{ref_key:"formItemRef",ref:z,class:e.normalizeClass(Q.value),role:b.value?"group":void 0,"aria-labelledby":b.value?e.unref(g):void 0},[e.createVNode(e.unref(le.default),{"is-auto-width":R.value.width==="auto","update-all":((l=e.unref(t))==null?void 0:l.labelWidth)==="auto"},{default:e.withCtx(()=>[S.value?(e.openBlock(),e.createBlock(e.resolveDynamicComponent(q.value?"label":"div"),{key:0,id:e.unref(g),for:q.value,class:e.normalizeClass(e.unref(a).e("item-label")),style:e.normalizeStyle(R.value)},{default:e.withCtx(()=>[e.renderSlot(r.$slots,"label",{label:M.value},()=>[e.createTextVNode(e.toDisplayString(M.value),1)])]),_:3},8,["id","for","class","style"])):e.createCommentVNode("",!0)]),_:3},8,["is-auto-width","update-all"]),e.createElementVNode("div",{class:e.normalizeClass(e.unref(a).e("item-content")),style:e.normalizeStyle(H.value)},[e.renderSlot(r.$slots,"default"),e.createVNode(e.TransitionGroup,{name:`${e.unref(w.defaultNamespace)}-zoom-in-top`},{default:e.withCtx(()=>[K.value?e.renderSlot(r.$slots,"error",{key:0,error:p.value},()=>[e.createElementVNode("div",{class:e.normalizeClass(X.value)},e.toDisplayString(p.value),3)]):e.createCommentVNode("",!0)]),_:3},8,["name"])],6)],10,ue)}}});exports.default=oe;
