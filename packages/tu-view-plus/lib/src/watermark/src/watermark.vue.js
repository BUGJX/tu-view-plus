"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const a=require("vue"),ee=require("./watermark.js"),A=require("@tu-view-plus/hooks"),te=require("@tu-view-plus/utils"),E=require("../utils/index.js");require("../style/watermark.css");const ae=a.defineComponent({name:"TuWatermark"}),oe=a.defineComponent({...ae,props:ee.watermarkProps,setup(I){const P=A.useNamespace("watermark"),o=I,{width:q,height:C,image:p,rotate:L,alpha:D,grayscale:H}=a.toRefs(o),c=window.devicePixelRatio||1,l=a.shallowRef(),v=a.ref(new Map),g=a.computed(()=>{var e;return((e=o.font)==null?void 0:e.fontSize)??16}),X=a.computed(()=>{var e;return((e=o.font)==null?void 0:e.fontWeight)??"lighter"}),Y=a.computed(()=>{var e;return((e=o.font)==null?void 0:e.fontStyle)??"normal"}),w=a.computed(()=>{var e;return((e=o.font)==null?void 0:e.fontFamily)??"sans-serif"}),B=a.computed(()=>{var e;return((e=o.font)==null?void 0:e.color)??"rgba(128, 128, 128, 0.18)"}),F=a.computed(()=>{var e;return((e=o.font)==null?void 0:e.textAlign)??"center"}),m=a.computed(()=>te.isArray(o.content)?o.content:[o.content]),f=a.computed(()=>{var e;return((e=o.gap)==null?void 0:e[0])??90}),h=a.computed(()=>{var e;return((e=o.gap)==null?void 0:e[1])??90}),x=a.computed(()=>f.value/2),y=a.computed(()=>h.value/2),N=a.computed(()=>{var e;return((e=o.offset)==null?void 0:e[0])??x.value}),O=a.computed(()=>{var e;return((e=o.offset)==null?void 0:e[1])??y.value}),U=a.computed(()=>{const e=N.value-x.value,t=O.value-y.value;return{position:"absolute",left:e>0?`${e}px`:0,top:t>0?`${t}px`:0,width:e>0?`calc(100% - ${e}px)`:"100%",height:t>0?`calc(100% - ${t}px)`:"100%",pointerEvents:"none",backgroundRepeat:o.repeat?"repeat":"no-repeat",backgroundPosition:`${e>0?0:e}px ${t>0?0:t}px`,zIndex:o.zIndex??6}}),b=a.computed(()=>o.repeat&&o.staggered),j=(e,t)=>{var n;if(l.value){const r=v.value.get(l.value);r&&(l.value.contains(r)&&l.value.removeChild(r),v.value.delete(l.value));const s=document.createElement("div");s.setAttribute("style",E.styleToString({...U.value,backgroundImage:`url('${e}')`,backgroundSize:`${t}px`})),(n=l.value)==null||n.append(s),v.value.set(l.value,s)}},G=e=>{let t=120,n=28;if(!p.value&&e.measureText){e.font=`${g.value}px ${w.value}`;const r=m.value.map(s=>e.measureText(s).width);t=Math.ceil(Math.max(...r)),n=g.value*m.value.length+(m.value.length-1)*3}return[q.value??t,C.value??n]},$=()=>{var z;const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return;const[n,r]=G(t),s=n*c,K=r*c,i=(f.value+n)*c,d=(h.value+r)*c,M=f.value/2*c,W=h.value/2*c,R=i/2,T=d/2,k=b.value?2:1,Q=(f.value+n)*k;e.width=i*k,e.height=d*k,t.globalAlpha=D.value,t.save(),t.translate(R,T),t.rotate(Math.PI/180*L.value),t.translate(-R,-T);const _=()=>{t.restore(),b.value&&t.drawImage(e,0,0,i,d,i,d,i,d),H.value&&E.canvasToGray(e),j(e.toDataURL(),Q),console.log("canvas.toDataURL()",e.toDataURL())};if(p.value){const u=new Image;u.onload=()=>{t.drawImage(u,M,W,s,K),_()},u.crossOrigin="anonymous",u.referrerPolicy="no-referrer",u.src=p.value}else{const u=Number(g.value)*c;t.font=`${Y.value} normal ${X.value} ${u}px/${r}px ${w.value}`,t.fillStyle=B.value,t.textAlign=F.value,t.textBaseline="top",t.translate(s/2,0),(z=m.value)==null||z.forEach((V,Z)=>{t.fillText(V??"",M,W+Z*(u+3*c))}),_()}},S=e=>Array.from(v.value.values()).includes(e),J=e=>{if(o.antiTamper)for(const t of e){const n=Array.from(t.removedNodes).some(s=>S(s)),r=t.type==="attributes"&&S(t.target);if(n||r){$();break}}};return a.onMounted(()=>{$(),A.useMutationObserver(l.value,J,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}),(e,t)=>(a.openBlock(),a.createElementBlock("div",a.mergeProps({ref_key:"containerRef",ref:l,class:a.unref(P).b(),style:{position:"relative",overflow:"hidden"}},e.$attrs),[a.renderSlot(e.$slots,"default")],16))}});exports.default=oe;
