"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const a=require("vue"),ve=require("./range-picker.js");require("../../form/index.js");const n=require("@tu-view-plus/utils"),E=require("@tu-view-plus/hooks"),la=require("@tu-view-plus/icons-vue"),oa=require("./hooks/use-format.js"),na=require("./hooks/use-is-disabled-date.js"),X=require("./hooks/use-value-format.js"),x=require("../../time-picker/src/utils.js"),sa=require("./hooks/use-range-picker-state.js"),ia=require("./hooks/use-range-header-value.js"),ca=require("./hooks/use-range-time-picker-value.js"),d=require("./utils.js"),da=require("../../range-picker/index.js"),va=require("../../trigger/index.js"),pa=require("../../icon/index.js"),pe=require("./range-picker-dropdown.vue.js"),me=require("../../form/src/hooks/use-form-props.js"),ma=a.defineComponent({name:"TuRangePicker",inheritAttrs:!1}),fa=a.defineComponent({...ma,props:ve.rangePickerProps,emits:ve.rangePickerEmits,setup(fe,{emit:ge}){const B=fe,c=ge,P=a.useSlots(),{t:i}=E.useLocale(),{mode:C,showTime:N,format:Ve,modelValue:he,defaultValue:Pe,popupVisible:ke,defaultPopupVisible:z,placeholder:A,timePickerProps:f,disabled:k,disabledDate:Se,disabledTime:be,pickerValue:Ce,defaultPickerValue:ye,valueFormat:Te,size:ga,error:we,exchangeTime:He,previewShortcut:Y,showConfirmBtn:Re}=a.toRefs(B),Z=me.useFormSize(),ee=me.useFormDisabled(),De=a.computed(()=>(A==null?void 0:A.value)||{date:[i("tu.datepicker.rangePlaceholder.dateStart"),i("tu.datepicker.rangePlaceholder.dateEnd")],month:[i("tu.datepicker.rangePlaceholder.monthStart"),i("tu.datepicker.rangePlaceholder.monthEnd")],year:[i("tu.datepicker.rangePlaceholder.yearStart"),i("tu.datepicker.rangePlaceholder.yearEnd")],week:[i("tu.datepicker.rangePlaceholder.weekStart"),i("tu.datepicker.rangePlaceholder.weekEnd")],quarter:[i("tu.datepicker.rangePlaceholder.quarterStart"),i("tu.datepicker.rangePlaceholder.quarterEnd")]}[C.value]||[i("tu.datepicker.rangePlaceholder.dateStart"),i("tu.datepicker.rangePlaceholder.dateEnd")]),{format:y,valueFormat:L,parseValueFormat:S}=oa.useFormat(a.reactive({mode:C,format:Ve,showTime:N,valueFormat:Te})),g=a.computed(()=>{const e=k.value===!0||ee.value===!0||n.isArray(k.value)&&k.value[0]===!0,t=k.value===!0||ee.value===!0||n.isArray(k.value)&&k.value[1]===!0;return[e,t]}),qe=a.computed(()=>!!(g.value[0]&&g.value[1])),ae=(e=0)=>g.value[e]?e^1:e,F=a.ref(),l=a.ref(ae()),j=a.computed(()=>{const e=l.value,t=e^1;return g.value[t]?e:t}),Ie=a.computed(()=>g.value[l.value^1]),{value:T,setValue:Ee}=sa.useRangePickerState(a.reactive({modelValue:he,defaultValue:Pe,format:S})),[V,U]=E.useState(),[xe,w]=E.useState(),W=a.computed(()=>V.value??T.value),o=a.computed(()=>xe.value??V.value??T.value),[_,v]=E.useState(),p=a.ref(),m=a.ref(),[h,Fe]=E.useMergeState(z==null?void 0:z.value,a.reactive({value:ke})),G=e=>{h.value!==e&&(Fe(e),c("popup-visible-change",e),c("update:popupVisible",e))},{startHeaderValue:J,endHeaderValue:K,startHeaderOperations:Me,endHeaderOperations:Oe,resetHeaderValue:M,setHeaderValue:te}=ia.useRangeHeaderValue(a.reactive({mode:C,startHeaderMode:p,endHeaderMode:m,value:Ce,defaultValue:ye,selectedValue:o,format:S,onChange:e=>{const t=X.getReturnRangeValue(e,L.value),r=x.getFormattedValue(e,S.value),u=n.getDateValue(e);c("picker-value-change",t,u,r),c("update:pickerValue",t)}})),$e=e=>{p.value=e},Be=e=>{m.value=e},Ne=e=>{let t=J.value;t=t.set("year",e.year()),p.value==="month"&&(t=t.set("month",e.month())),te([t,K.value]),p.value=void 0},ze=e=>{let t=K.value;t=t.set("year",e.year()),m.value==="month"&&(t=t.set("month",e.month())),te([J.value,t]),m.value=void 0},H=a.ref([o.value[0]||n.getNow(),o.value[1]||n.getNow()]);a.watch(o,()=>{const[e,t]=o.value;H.value[0]=e||H.value[0],H.value[1]=t||H.value[1]});const[R,Ae,Le]=ca.useRangeTimePickerValue(a.reactive({timePickerProps:f,selectedValue:o})),re=a.computed(()=>C.value==="date"&&N.value),ue=a.computed(()=>re.value||(f==null?void 0:f.value)),D=na.useIsDisabledDate(a.reactive({mode:C,isRange:!0,showTime:N,disabledDate:Se,disabledTime:be})),O=a.computed(()=>re.value||Re.value),je=a.computed(()=>O.value&&(!d.isCompleteRangeValue(W.value)||D(W.value[0],"start")||D(W.value[1],"end")));a.watch(h,e=>{p.value=void 0,m.value=void 0,U(void 0),w(void 0),e&&(M(),Le(),l.value=ae(l.value),a.nextTick(()=>se(l.value))),e||v(void 0)}),a.watch(l,()=>{B.disabledInput&&(se(l.value),v(void 0))});const Ue=(e,t)=>{const r=e?X.getReturnRangeValue(e,L.value):void 0,u=x.getFormattedValue(e,S.value),s=n.getDateValue(e);n.isValueChange(e,T.value)&&(c("update:modelValue",r),c("change",r,s,u)),t&&c("ok",r,s,u)},le=e=>{let t=n.getSortedDayjsArray(e);return ue.value&&!He.value&&(t=[I(t[0],e[0]),I(t[1],e[1])]),t},q=(e,t,r)=>{if(D(e==null?void 0:e[0],"start")||D(e==null?void 0:e[1],"end"))return;let u=e?[...e]:void 0;d.isCompleteRangeValue(u)&&(u=le(u)),Ue(u,r),Ee(u||[]),U(void 0),w(void 0),v(void 0),p.value=void 0,m.value=void 0,n.isBoolean(t)&&G(t)},oe=e=>{const t=X.getReturnRangeValue(e,L.value),r=x.getFormattedValue(e,S.value),u=n.getDateValue(e);c("select",t,u,r)},Q=(e,t)=>{const{emitSelect:r=!1,updateHeader:u=!1}=t||{};let s=[...e];d.isCompleteRangeValue(s)&&(s=le(s)),U(s),w(void 0),v(void 0),p.value=void 0,m.value=void 0,r&&oe(s),u&&M()},ne=(e,t)=>{const{updateHeader:r=!1}=t||{};w(e),v(void 0),r&&M()},se=e=>{F.value&&F.value.focus&&F.value.focus(e)},I=(e,t)=>ue.value?d.mergeValueWithTime(n.getNow(),e,t):e,We=e=>{G(e)},_e=e=>{if(V.value&&o.value[j.value]&&(!O.value||!d.isCompleteRangeValue(V.value))){const t=[...o.value],r=I(e,R.value[l.value]);t[l.value]=r,ne(t)}},ie=(e=!1)=>Ie.value?[...T.value]:V.value?e||!d.isCompleteRangeValue(V.value)?[...V.value]:[]:e?[...T.value]:[],Ge=e=>{const t=ie(),r=I(e,R.value[l.value]);t[l.value]=r,oe(t),!O.value&&d.isCompleteRangeValue(t)?q(t,!1):(Q(t),d.isCompleteRangeValue(t)?l.value=0:l.value=j.value)},Je=(e,t)=>{const r=t==="start"?0:1,u=I(R.value[r],e),s=[...R.value];s[r]=u,Ae(s);const b=ie(!0);b[r]&&(b[r]=u,Q(b,{emitSelect:!0}))};let $;a.onUnmounted(()=>{clearTimeout($)});const Ke=e=>{clearTimeout($),ne(e,{updateHeader:!0})},Qe=()=>{clearTimeout($),$=setTimeout(()=>{w(void 0),v(void 0),M()},100)},Xe=(e,t)=>{c("select-shortcut",t),q(e,!1)},Ye=()=>{q(o.value,!1,!0)},Ze=e=>{e.stopPropagation(),q(void 0),c("clear")},ea=e=>{G(!0);const t=e.target.value;if(!t){v(void 0);return}const r=x.getFormattedValue(o.value,y.value),u=n.isArray(_.value)?[..._.value]:r||[];if(u[l.value]=t,v(u),!x.isValidInputValue(t,y.value))return;const s=n.dayjs(t,y.value);if(D(s,l.value===0?"start":"end"))return;const b=n.isArray(o.value)?[...o.value]:[];b[l.value]=s,Q(b,{updateHeader:!0})},aa=()=>{d.isValidRangeValue(o.value)?q(o.value,!1):l.value=j.value},ta=a.computed(()=>({format:y.value,...n.omit((f==null?void 0:f.value)||{},["defaultValue"]),visible:h.value})),ce=a.computed(()=>({prev:P["icon-prev"],prevDouble:P["icon-prev-double"],next:P["icon-next"],nextDouble:P["icon-next-double"]})),ra=a.reactive({headerValue:J,headerOperations:Me,headerIcons:ce}),ua=a.reactive({headerValue:K,headerOperations:Oe,headerIcons:ce}),de=a.computed(()=>({...n.pick(B,["mode","showTime","shortcuts","shortcutsPosition","dayStartOfWeek","disabledDate","disabledTime","hideTrigger","abbreviation"]),size:Z.value,format:S.value,value:o.value,showConfirmBtn:O.value,confirmBtnDisabled:je.value,timePickerValue:R.value,timePickerProps:ta.value,extra:P.extra,dateRender:P.cell,startHeaderProps:ra,endHeaderProps:ua,footerValue:H.value,disabled:g.value,visible:h.value,onCellClick:Ge,onCellMouseEnter:_e,onShortcutClick:Xe,onShortcutMouseEnter:Y.value?Ke:void 0,onShortcutMouseLeave:Y.value?Qe:void 0,onConfirm:Ye,onTimePickerSelect:Je,startHeaderMode:p.value,endHeaderMode:m.value,onStartHeaderLabelClick:$e,onEndHeaderLabelClick:Be,onStartHeaderSelect:Ne,onEndHeaderSelect:ze}));return(e,t)=>e.hideTrigger?(a.openBlock(),a.createBlock(pe.default,a.normalizeProps(a.mergeProps({key:1},{...e.$attrs,...de.value})),null,16)):(a.openBlock(),a.createBlock(a.unref(va.TuTrigger),a.mergeProps({key:0},e.triggerProps,{trigger:"click","animation-name":"slide-dynamic-origin","auto-fit-transform-origin":"","click-to-close":!1,"popup-offset":10,"unmount-on-close":e.unmountOnClose,position:e.position,disabled:qe.value||e.readonly,"popup-visible":a.unref(h),"popup-container":e.popupContainer,onPopupVisibleChange:We}),{content:a.withCtx(()=>[a.createVNode(pe.default,a.normalizeProps(a.guardReactiveProps(de.value)),null,16)]),default:a.withCtx(()=>[a.renderSlot(e.$slots,"default",{},()=>[a.createVNode(a.unref(da.TuRangePicker),a.mergeProps({ref_key:"refInput",ref:F},e.$attrs,{focusedIndex:l.value,"onUpdate:focusedIndex":t[0]||(t[0]=r=>l.value=r),size:a.unref(Z),focused:a.unref(h),visible:a.unref(h),error:a.unref(we),disabled:g.value,readonly:e.readonly||e.disabledInput,"allow-clear":e.allowClear&&!e.readonly,placeholder:De.value,"input-value":a.unref(_),value:o.value,format:a.unref(y),onClear:Ze,onChange:ea,onPressEnter:aa}),a.createSlots({"suffix-icon":a.withCtx(()=>[a.renderSlot(e.$slots,"suffix-icon",{},()=>[a.createVNode(a.unref(pa.TuIcon),null,{default:a.withCtx(()=>[a.createVNode(a.unref(la.Calendar))]),_:1})])]),separator:a.withCtx(()=>[a.renderSlot(e.$slots,"separator",{},()=>[a.createTextVNode(a.toDisplayString(e.separator||"-"),1)])]),_:2},[e.$slots.prefix?{name:"prefix",fn:a.withCtx(()=>[a.renderSlot(e.$slots,"prefix")]),key:"0"}:void 0]),1040,["focusedIndex","size","focused","visible","error","disabled","readonly","allow-clear","placeholder","input-value","value","format"])])]),_:3},16,["unmount-on-close","position","disabled","popup-visible","popup-container"]))}});exports.default=fa;
