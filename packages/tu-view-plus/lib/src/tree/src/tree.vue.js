"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const r=require("vue"),O=require("./tree.js"),d=require("@tu-view-plus/hooks"),E=require("@tu-view-plus/utils");require("../../form/index.js");const Ce=require("./hooks/use-checked-state.js"),Pe=require("./context.js"),we=require("./hooks/use-tree-data.js"),be=require("./utils/check-utils.js"),qe=require("../../virtual-list/index.js"),R=require("./tree-node.vue.js");require("../style/tree.css");const Te=require("../../form/src/hooks/use-form-props.js"),Be=r.defineComponent({name:"TuTree"}),Le=r.defineComponent({...Be,props:O.treeProps,emits:O.treeEmits,setup(z,{emit:U}){const w=z,l=U,i=r.useSlots(),{data:j,showLine:b,multiple:V,loadMore:v,checkStrictly:q,checkedKeys:A,defaultCheckedKeys:G,selectedKeys:H,defaultSelectedKeys:N,expandedKeys:J,defaultExpandedKeys:K,checkedStrategy:Q,selectable:W,checkable:T,blockNode:X,fieldNames:Y,defaultExpandAll:Z,filterTreeNode:p,draggable:$,allowDrop:S,defaultExpandSelected:B,defaultExpandChecked:L,autoExpandParent:ee,halfCheckedKeys:te,onlyCheckLeaf:ne,animation:ae}=r.toRefs(w),k=d.useNamespace("tree"),re=Te.useFormSize(),oe=r.computed(()=>({[k.b()]:!0,[k.m(re.value)]:!0,[k.is("checkable")]:T.value,[k.is("show-line")]:b.value})),se=d.usePickSlots(i,"switcher-icon"),ce=d.usePickSlots(i,"loading-icon"),le=d.usePickSlots(i,"drag-icon"),de=d.usePickSlots(i,"icon"),ue=d.usePickSlots(i,"title"),ie=d.usePickSlots(i,"extra"),{treeData:ve,flattenTreeData:D,key2TreeNode:c}=we.useTreeData(r.reactive({treeData:j,selectable:W,showLine:b,blockNode:X,checkable:T,fieldNames:Y,loadMore:v,draggable:$})),{checkedKeys:m,indeterminateKeys:_,setCheckedState:pe}=Ce.useCheckedState(r.reactive({defaultCheckedKeys:G,checkedKeys:A,checkStrictly:q,key2TreeNode:c,halfCheckedKeys:te,onlyCheckLeaf:ne})),[C,fe]=d.useMergeState((N==null?void 0:N.value)||[],r.reactive({value:H})),u=r.ref([]),f=r.ref(),he=r.ref();function ge(){if(K!=null&&K.value){const e=new Set([]);return K.value.forEach(t=>{if(e.has(t))return;const n=c.value.get(t);n&&[...ee.value?n.pathParentKeys:[],t].forEach(a=>e.add(a))}),[...e]}if(Z.value)return D.value.filter(e=>e.children&&e.children.length).map(e=>e.key);if(B.value||L.value){const e=new Set([]),t=n=>{n.forEach(a=>{const o=c.value.get(a);o&&(o.pathParentKeys||[]).forEach(s=>e.add(s))})};return B.value&&t(C.value),L.value&&t(m.value),[...e]}return[]}const[P,ye]=d.useMergeState(ge(),r.reactive({value:J})),h=r.ref([]),F=r.computed(()=>{const e=new Set(P.value),t=new Set(h.value);return D.value.filter(n=>{var g;if(!(!p||!p.value||(p==null?void 0:p.value(n.treeNodeData))))return!1;const o=E.isUndefined(n.parentKey),s=(g=n.pathParentKeys)==null?void 0:g.every(y=>e.has(y)&&!t.has(y));return o||s})});function Ke(e,t=Q.value){let n=[...e];return t==="parent"?n=e.filter(a=>{const o=c.value.get(a);return o&&!(!E.isUndefined(o.parentKey)&&e.includes(o.parentKey))}):t==="child"&&(n=e.filter(a=>{var o,s;return!((s=(o=c.value.get(a))==null?void 0:o.children)!=null&&s.length)})),n}function x(e){return e.map(t=>{var n;return((n=c.value.get(t))==null?void 0:n.treeNodeData)||void 0}).filter(Boolean)}function Se(e){const{targetKey:t,targetChecked:n,newCheckedKeys:a,newIndeterminateKeys:o,event:s}=e,g=t?c.value.get(t):void 0,y=Ke(a);l("update:checkedKeys",y),l("update:halfCheckedKeys",o),l("check",y,{checked:n,node:g==null?void 0:g.treeNodeData,checkedNodes:x(y),halfCheckedKeys:o,halfCheckedNodes:x(o),e:s})}function ke(e){const{targetKey:t,targetSelected:n,newSelectedKeys:a,event:o}=e,s=t?c.value.get(t):void 0;l("update:selectedKeys",a),l("select",a,{selected:n,node:s==null?void 0:s.treeNodeData,selectedNodes:x(a),e:o})}function me(e){const{targetKey:t,targetExpanded:n,newExpandedKeys:a,event:o}=e,s=t?c.value.get(t):void 0;l("expand",a,{expanded:n,node:s==null?void 0:s.treeNodeData,expandedNodes:x(a),e:o}),l("update:expandedKeys",a)}function I(e,t,n){const a=c.value.get(t);if(!a)return;const[o,s]=be.getCheckedStateByCheck({node:a,checked:e,checkedKeys:m.value,indeterminateKeys:_.value,checkStrictly:q.value});pe(o,s),Se({targetKey:t,targetChecked:e,newCheckedKeys:o,newIndeterminateKeys:s,event:n})}function xe(e,t){if(!c.value.get(e))return;let a,o;if(V.value){const s=new Set(C.value);o=!s.has(e),o?s.add(e):s.delete(e),a=[...s]}else o=!0,a=[e];fe(a),ke({targetKey:e,targetSelected:o,newSelectedKeys:a,event:t})}function M(e,t,n){if(h.value.includes(t)||!c.value.get(t))return;const o=new Set(P.value);e?o.add(t):o.delete(t);const s=[...o];ye(s),ae.value&&h.value.push(t),me({targetKey:t,targetExpanded:e,newExpandedKeys:s,event:n})}function Ee(e){const t=h.value.indexOf(e);h.value.splice(t,1)}const Ne=r.computed(()=>v!=null&&v.value?async e=>{if(!E.isFunction(v.value))return;const t=c.value.get(e);if(!t)return;const{treeNodeData:n}=t;u.value=[...new Set([...u.value,e])];try{await v.value(n),u.value=u.value.filter(a=>a!==e),M(!0,e),m.value.includes(e)&&I(!0,e)}catch(a){u.value=u.value.filter(o=>o!==e),console.error("[tree]load data error: ",a)}}:void 0),De=r.reactive({treeProps:w,switcherIcon:se,loadingIcon:ce,dragIcon:le,nodeIcon:de,nodeTitle:ue,nodeExtra:ie,treeData:ve,flattenTreeData:D,key2TreeNode:c,checkedKeys:m,indeterminateKeys:_,selectedKeys:C,expandedKeys:P,loadingKeys:u,currentExpandKeys:h,onLoadMore:Ne,filterTreeNode:p,onCheck:I,onSelect:xe,onExpand:M,onExpandEnd:Ee,allowDrop(e,t){const n=c.value.get(e);return n&&E.isFunction(S==null?void 0:S.value)?!!S.value({dropNode:n.treeNodeData,dropPosition:t}):!0},onDragStart(e,t){const n=c.value.get(e);f.value=n,n&&l("dragStart",t,n.treeNodeData)},onDragEnd(e,t){const n=c.value.get(e);f.value=void 0,n&&l("dragEnd",t,n.treeNodeData)},onDragOver(e,t){const n=c.value.get(e);n&&l("dragOver",t,n.treeNodeData)},onDragLeave(e,t){const n=c.value.get(e);n&&l("dragLeave",t,n.treeNodeData)},onDrop(e,t,n){const a=c.value.get(e);f.value&&a&&!(a.key===f.value.key||a.pathParentKeys.includes(f.value.key||""))&&l("drop",{e:n,dragNode:f.value.treeNodeData,dropNode:a.treeNodeData,dropPosition:t})}});return r.provide(Pe.TreeInjectionKey,De),(e,t)=>(r.openBlock(),r.createElementBlock("div",{class:r.normalizeClass(oe.value)},[e.virtualListProps?(r.openBlock(),r.createBlock(r.unref(qe.TuVirtualList),r.mergeProps({key:0,ref_key:"virtualListRef",ref:he},e.virtualListProps,{data:F.value}),{item:r.withCtx(({item:n})=>[(r.openBlock(),r.createBlock(R.default,r.mergeProps(n.treeNodeProps,{key:n.key}),null,16))]),_:1},16,["data"])):(r.openBlock(!0),r.createElementBlock(r.Fragment,{key:1},r.renderList(F.value,n=>(r.openBlock(),r.createBlock(R.default,r.mergeProps(n.treeNodeProps,{key:n.key}),null,16))),128))],2))}});exports.default=Le;
