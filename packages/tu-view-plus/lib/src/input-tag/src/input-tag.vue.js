"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),P=require("./input-tag.js"),D=require("@tu-view-plus/hooks"),M=require("@tu-view-plus/constants"),h=require("@tu-view-plus/utils"),se=require("@tu-view-plus/icons-vue"),re=require("../../resize-observer/index.js"),ie=require("./utils.js");require("../../form/index.js");const ce=require("../../tag/index.js"),de=require("../../icon/index.js");require("../style/input-tag.css");const F=require("../../form/src/hooks/use-form-props.js"),pe=require("../../form/src/hooks/use-form-item.js"),fe=["placeholder","disabled","readonly"],ve=e.defineComponent({name:"TuInputTag",inheritAttrs:!1}),me=e.defineComponent({...ve,props:P.inputTagProps,emits:P.inputTagEmits,setup($,{emit:R}){const A={value:"value",label:"label",closable:"closable",tagProps:"tagProps"},l=$,s=R,I=e.useAttrs(),L=e.useSlots(),r=D.useNamespace("input-tag"),E=F.useFormSize(),p=F.useFormDisabled(),{form:ge,formItem:C}=pe.useFormItem(),b=e.reactive({width:"12px"}),f=e.ref(),o=e.ref(),c=e.ref(!1),T=e.ref(!1),g=e.ref(""),O=e.computed(()=>({...A,...l.fieldNames})),_=e.ref(!1),N=e.ref(l.defaultValue),x=e.ref(l.defaultInputValue),U=e.computed(()=>h.omit(I,M.INPUT_EVENTS)),W=e.computed(()=>h.pick(I,M.INPUT_EVENTS)),j=e.computed(()=>m.value.length>0?g.value||n.value:g.value||n.value||l.placeholder),v=e.computed(()=>l.modelValue??N.value),n=e.computed(()=>l.inputValue??x.value),d=e.computed(()=>ie.getValueData(v.value,O.value)),K=e.computed(()=>["small","mini"].indexOf(l.size)>-1?"mini":l.size==="large"?"medium":"small"),m=e.computed(()=>{if(l.maxTagCount>0){const a=d.value.length-l.maxTagCount;if(a>0){const t=d.value.slice(0,l.maxTagCount),u={value:"__tu__tag__more",label:`${a}..`,closable:!1};return t.push({raw:u,...u}),t}}return d.value}),G=e.computed(()=>!p.value&&!l.readonly&&l.allowClear&&!!v.value.length&&T.value),z=e.computed(()=>(C==null?void 0:C.validateState)||""),S=e.computed(()=>h.isObject(l.retainInputValue)?{create:!1,blur:!1,...l.retainInputValue}:{create:l.retainInputValue,blur:l.retainInputValue});e.computed(()=>z.value&&h.ValidateComponentsMap[z.value]);const H=e.computed(()=>({[r.b()]:!0,[r.m(E.value)]:E.value,[r.m("has-tag")]:m.value.length>0,[r.is("disabled")]:p.value})),J=a=>{T.value=!0,s("mouseenter",a)},Q=a=>{T.value=!1,s("mouseleave",a)},X=a=>{o.value&&a.target!==o.value&&(a.preventDefault(),o.value.focus())},Y=()=>{f.value&&B(f.value.offsetWidth)},Z=a=>{const{value:t}=a.target;c.value||(V(t,a),e.nextTick(()=>{o.value&&n.value!==o.value.value&&(o.value.value=n.value)}))},ee=a=>{const t=a.key||a.code;if(!c.value&&n.value&&t==="Enter"&&ue(a),!c.value&&m.value.length>0&&!n.value&&t==="Backspace"){const u=ne();u>=0&&q(d.value[u].value,u,a)}},ae=a=>{_.value=!0,s("focus",a)},te=a=>{_.value=!1,!S.value.blur&&n.value&&V("",a),s("blur",a)},k=a=>{const{value:t}=a.target;a.type==="compositionend"?(c.value=!1,g.value="",V(t,a),e.nextTick(()=>{o.value&&n.value!==o.value.value&&(o.value.value=n.value)})):(c.value=!0,g.value=n.value+(a.data??""))},le=a=>{w([],a),s("clear",a)},q=(a,t,u)=>{var i;const y=(i=v.value)==null?void 0:i.filter((Ve,oe)=>oe!==t);w(y,u),s("remove",a,u)},ue=a=>{var t;if(n.value){if(a.preventDefault(),l.uniqueValue&&((t=v.value)!=null&&t.includes(n.value))){s("pressEnter",n.value,a);return}const u=v.value.concat(n.value);w(u,a),s("pressEnter",n.value,a),S.value.create||V("",a)}},V=(a,t)=>{x.value=a,s("update:inputValue",a),s("inputValueChange",a,t)},ne=()=>{for(let a=d.value.length-1;a>=0;a--)if(d.value[a].closable)return a;return-1},w=(a,t)=>{N.value=a,s("update:modelValue",a),s("change",a,t)},B=a=>{a>12?b.width=`${a}px`:b.width="12px"};return e.watch(n,a=>{o.value&&!c.value&&a!==o.value.value&&(o.value.value=a)}),e.onMounted(()=>{f.value&&B(f.value.offsetWidth)}),(a,t)=>(e.openBlock(),e.createElementBlock("div",e.mergeProps(U.value,{class:H.value,onMousedown:X,onMouseenter:J,onMouseleave:Q}),[e.createVNode(e.unref(re.TuResizeObserver),{onResize:Y},{default:e.withCtx(()=>[e.createElementVNode("span",{ref_key:"mirrorRef",ref:f,class:e.normalizeClass(e.unref(r).e("mirror"))},e.toDisplayString(j.value),3)]),_:1}),e.unref(L).prefix?(e.openBlock(),e.createElementBlock("span",{key:0,class:e.normalizeClass(e.unref(r).e("prefix"))},[e.renderSlot(a.$slots,"prefix")],2)):e.createCommentVNode("",!0),e.createVNode(e.TransitionGroup,{tag:"span",name:`${e.unref(D.defaultNamespace)}-input-tag-zoom`,class:e.normalizeClass(e.unref(r).e("inner"))},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(m.value,(u,y)=>(e.openBlock(),e.createBlock(e.unref(ce.TuTag),e.mergeProps(u.tagProps,{disableTransitions:"",size:K.value,key:`tag-${u.value}`,class:e.unref(r).e("tag"),closable:!e.unref(p)&&!a.readonly&&u.closable,disabled:e.unref(p),onClose:i=>q(u.value,y,i)}),{default:e.withCtx(()=>{var i;return[e.createTextVNode(e.toDisplayString(((i=a.formatTag)==null?void 0:i.call(a,u.raw))??u.label),1)]}),_:2},1040,["size","class","closable","disabled","onClose"]))),128)),e.createElementVNode("input",e.mergeProps({ref_key:"inputRef",ref:o,key:"input-tag-input"},W.value,{class:e.unref(r).e("input"),style:b,placeholder:m.value.length===0?l.placeholder:void 0,disabled:e.unref(p),readonly:l.readonly||l.disabledInput,onInput:Z,onKeydown:ee,onFocus:ae,onBlur:te,onCompositionstart:k,onCompositionupdate:k,onCompositionend:k}),null,16,fe)]),_:1},8,["name","class"]),e.createElementVNode("span",{class:e.normalizeClass(e.unref(r).e("suffix"))},[G.value?(e.openBlock(),e.createBlock(e.unref(de.TuIcon),{key:0,class:e.normalizeClass([e.unref(r).e("icon"),e.unref(r).em("icon","clear")]),onClick:le,onMousedown:t[0]||(t[0]=u=>u.stopPropagation())},{default:e.withCtx(()=>[e.createVNode(e.unref(se.Close))]),_:1},8,["class"])):e.createCommentVNode("",!0),e.renderSlot(a.$slots,"suffix")],2)],16))}});exports.default=me;
