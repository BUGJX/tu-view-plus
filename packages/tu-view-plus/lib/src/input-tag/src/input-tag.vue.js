"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),z=require("./input-tag.js"),ce=require("@tu-view-plus/hooks"),D=require("@tu-view-plus/constants"),F=require("@tu-view-plus/utils"),ie=require("@tu-view-plus/icons-vue"),de=require("../../resize-observer/index.js"),pe=require("./utils.js");require("../../form/index.js");const P=require("lodash"),ve=require("../../tag/index.js"),R=require("../../icon/index.js");require("../style/input-tag.css");const M=require("../../form/src/hooks/use-form-props.js"),fe=require("../../form/src/hooks/use-form-item.js"),me=["placeholder","disabled","readonly"],ge=e.defineComponent({name:"TuInputTag"}),he=e.defineComponent({...ge,props:z.inputTagProps,emits:z.inputTagEmits,setup($,{emit:A}){const L={value:"value",label:"label",closable:"closable",tagProps:"tagProps"},l=$,s=A,I=e.useAttrs(),O=e.useSlots(),u=ce.useNamespace("input-tag"),y=M.useFormSize(),m=M.useFormDisabled(),{form:g,formItem:h}=fe.useFormItem(),w=e.reactive({width:"12px"}),V=e.ref(),r=e.ref(),d=e.ref(!1),_=e.ref(""),K=e.computed(()=>({...L,...l.fieldNames})),x=e.ref(!1),B=e.ref(l.defaultValue),E=e.ref(l.defaultInputValue),U=e.computed(()=>F.omit(I,D.INPUT_EVENTS)),j=e.computed(()=>P.pick(I,D.INPUT_EVENTS)),W=e.computed(()=>{}),p=e.computed(()=>l.modelValue??B.value),n=e.computed(()=>l.inputValue??E.value),c=e.computed(()=>pe.getValueData(p.value,K.value)),G=e.computed(()=>["small","mini"].indexOf(l.size)>-1?"mini":"small"),C=e.computed(()=>{if(console.log("tags",c.value),l.maxTagCount>0){const a=c.value.length-l.maxTagCount;if(a>0){const t=c.value.slice(0,l.maxTagCount),o={value:"__tu__more",label:`+${a}..`,closable:!1};return t.push({raw:o,...o}),t}}return c.value}),H=e.computed(()=>!m.value&&!l.readonly&&l.allowClear&&!!p.value.length),J=e.computed(()=>(g==null?void 0:g.statusIcon)??!1),v=e.computed(()=>(h==null?void 0:h.validateState)||""),N=e.computed(()=>P.isObject(l.retainInputValue)?{create:!1,blur:!1,...l.retainInputValue}:{create:l.retainInputValue,blur:l.retainInputValue}),S=e.computed(()=>v.value&&F.ValidateComponentsMap[v.value]),Q=e.reactive({width:"12px"}),X=e.computed(()=>({[u.b()]:!0,[u.m(y.value)]:y.value,[u.is("disabled")]:m.value})),Y=a=>{r.value&&a.target!==r.value&&(a.preventDefault(),r.value.focus())},Z=()=>{console.log("resize")},ee=a=>{const{value:t}=a.target;d.value||(f(t,a),e.nextTick(()=>{r.value&&n.value!==r.value.value&&(r.value.value=n.value)}))},ae=a=>{console.log("handleKeydown");const t=a.key||a.code;if(!d.value&&n.value&&t==="Enter"&&ne(a),!d.value&&C.value.length>0&&!n.value&&t==="Backspace"){const o=ue();o>=0&&q(c.value[o].value,o,a)}},te=a=>{console.log("handleFocus"),x.value=!0,s("focus",a)},le=a=>{console.log("handleBlur"),x.value=!1,!N.value.blur&&n.value&&f("",a),s("blur",a)},k=a=>{console.log("handleComposition",a);const{value:t}=a.target;a.type==="compositionend"?(d.value=!1,_.value="",f(t,a),e.nextTick(()=>{r.value&&n.value!==r.value.value&&(r.value.value=n.value)})):(d.value=!0,_.value=n.value+(a.data??""))},oe=a=>{console.log("clear"),T([],a),s("clear",a)},q=(a,t,o)=>{var i;console.log("handleRemove");const b=(i=p.value)==null?void 0:i.filter((Ve,re)=>re!==t);T(b,o),s("remove",a,o)},ne=a=>{var t;if(n.value){if(a.preventDefault(),l.uniqueValue&&((t=p.value)!=null&&t.includes(n.value))){s("pressEnter",n.value,a);return}const o=p.value.concat(n.value);T(o,a),s("pressEnter",n.value,a),N.value.create||f("",a)}},f=(a,t)=>{E.value=a,s("update:inputValue",a),s("inputValueChange",a,t)},ue=()=>{for(let a=c.value.length-1;a>=0;a--)if(c.value[a].closable)return a;return-1},T=(a,t)=>{B.value=a,s("update:modelValue",a),s("change",a,t)},se=a=>{a>12?w.width=`${a}px`:w.width="12px"};return e.onMounted(()=>{V.value&&se(V.value.offsetWidth)}),(a,t)=>(e.openBlock(),e.createElementBlock("div",e.mergeProps({class:X.value,onMousedown:Y},U.value),[e.createVNode(e.unref(de.TuResizeObserver),{onResize:Z},{default:e.withCtx(()=>[e.createElementVNode("span",{ref_key:"mirrorRef",ref:V,class:e.normalizeClass(e.unref(u).e("mirror"))},e.toDisplayString(W.value),3)]),_:1}),e.unref(O).prefix?(e.openBlock(),e.createElementBlock("span",{key:0,class:e.normalizeClass(e.unref(u).e("prefix"))},[e.renderSlot(a.$slots,"prefix")],2)):e.createCommentVNode("",!0),e.createVNode(e.TransitionGroup,{tag:"span",name:"input-tag-zoom",class:e.normalizeClass(e.unref(u).e("inner"))},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(C.value,(o,b)=>(e.openBlock(),e.createBlock(e.unref(ve.TuTag),e.mergeProps({closable:""},o.tagProps,{size:G.value,key:`tag-${o.value}`,class:e.unref(u).e("tag"),onClose:i=>q(o.value,b,i)}),{default:e.withCtx(()=>{var i;return[e.createTextVNode(e.toDisplayString(((i=a.formatTag)==null?void 0:i.call(a,o.raw))??o.label),1)]}),_:2},1040,["size","class","onClose"]))),128)),e.createElementVNode("input",e.mergeProps({ref_key:"inputRef",ref:r,key:"input-tag-input"},j.value,{class:e.unref(u).e("input"),style:Q,placeholder:C.value.length===0?l.placeholder:void 0,disabled:e.unref(m),readonly:l.readonly||l.disabledInput,onInput:ee,onKeydown:ae,onFocus:te,onBlur:le,onCompositionstart:k,onCompositionupdate:k,onCompositionend:k}),null,16,me)]),_:1},8,["class"]),H.value?(e.openBlock(),e.createBlock(e.unref(R.TuIcon),{key:1,onClick:oe},{default:e.withCtx(()=>[e.createVNode(e.unref(ie.Close))]),_:1})):e.createCommentVNode("",!0),v.value&&S.value&&J.value?(e.openBlock(),e.createBlock(e.unref(R.TuIcon),{key:2,class:e.normalizeClass([e.unref(u).e("icon"),e.unref(u).e("validateIcon"),e.unref(u).is("loading",v.value==="validating")])},{default:e.withCtx(()=>[(e.openBlock(),e.createBlock(e.resolveDynamicComponent(S.value)))]),_:1},8,["class"])):e.createCommentVNode("",!0)],16))}});exports.default=he;
