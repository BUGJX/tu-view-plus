"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),F=require("./input-tag.js"),se=require("@tu-view-plus/hooks"),P=require("@tu-view-plus/constants"),C=require("@tu-view-plus/utils"),re=require("@tu-view-plus/icons-vue"),ce=require("../../resize-observer/index.js"),ie=require("./utils.js");require("../../form/index.js");const de=require("../../tag/index.js"),R=require("../../icon/index.js");require("../style/input-tag.css");const M=require("../../form/src/hooks/use-form-props.js"),pe=require("../../form/src/hooks/use-form-item.js"),ve=["placeholder","disabled","readonly"],fe=e.defineComponent({name:"TuInputTag"}),me=e.defineComponent({...fe,props:F.inputTagProps,emits:F.inputTagEmits,setup($,{emit:A}){const L={value:"value",label:"label",closable:"closable",tagProps:"tagProps"},l=$,r=A,_=e.useAttrs(),O=e.useSlots(),s=se.useNamespace("input-tag"),B=M.useFormSize(),f=M.useFormDisabled(),{form:b,formItem:k}=pe.useFormItem(),T=e.reactive({width:"12px"}),p=e.ref(),o=e.ref(),d=e.ref(!1),m=e.ref(""),K=e.computed(()=>({...L,...l.fieldNames})),x=e.ref(!1),E=e.ref(l.defaultValue),N=e.ref(l.defaultInputValue),U=e.computed(()=>C.omit(_,P.INPUT_EVENTS)),W=e.computed(()=>C.pick(_,P.INPUT_EVENTS)),j=e.computed(()=>g.value.length>0?m.value||u.value:m.value||u.value||l.placeholder),v=e.computed(()=>l.modelValue??E.value),u=e.computed(()=>l.inputValue??N.value),c=e.computed(()=>ie.getValueData(v.value,K.value)),G=e.computed(()=>["small","mini"].indexOf(l.size)>-1?"mini":l.size==="large"?"medium":"small"),g=e.computed(()=>{if(console.log("tags",c.value),l.maxTagCount>0){const a=c.value.length-l.maxTagCount;if(a>0){const t=c.value.slice(0,l.maxTagCount),n={value:"__tu__more",label:`+${a}..`,closable:!1};return t.push({raw:n,...n}),t}}return c.value}),H=e.computed(()=>!f.value&&!l.readonly&&l.allowClear&&!!v.value.length),J=e.computed(()=>(b==null?void 0:b.statusIcon)??!1),h=e.computed(()=>(k==null?void 0:k.validateState)||""),z=e.computed(()=>C.isObject(l.retainInputValue)?{create:!1,blur:!1,...l.retainInputValue}:{create:l.retainInputValue,blur:l.retainInputValue}),S=e.computed(()=>h.value&&C.ValidateComponentsMap[h.value]),Q=e.computed(()=>({[s.b()]:!0,[s.m(B.value)]:B.value,[s.is("disabled")]:f.value})),X=a=>{o.value&&a.target!==o.value&&(a.preventDefault(),o.value.focus())},Y=()=>{p.value&&D(p.value.offsetWidth)},Z=a=>{const{value:t}=a.target;d.value||(V(t,a),e.nextTick(()=>{o.value&&u.value!==o.value.value&&(o.value.value=u.value)}))},ee=a=>{console.log("handleKeydown");const t=a.key||a.code;if(!d.value&&u.value&&t==="Enter"&&ne(a),!d.value&&g.value.length>0&&!u.value&&t==="Backspace"){const n=ue();n>=0&&q(c.value[n].value,n,a)}},ae=a=>{console.log("handleFocus"),x.value=!0,r("focus",a)},le=a=>{console.log("handleBlur"),x.value=!1,!z.value.blur&&u.value&&V("",a),r("blur",a)},I=a=>{console.log("handleComposition",a);const{value:t}=a.target;a.type==="compositionend"?(d.value=!1,m.value="",V(t,a),e.nextTick(()=>{o.value&&u.value!==o.value.value&&(o.value.value=u.value)})):(d.value=!0,m.value=u.value+(a.data??""))},te=a=>{console.log("clear"),w([],a),r("clear",a)},q=(a,t,n)=>{var i;console.log("handleRemove");const y=(i=v.value)==null?void 0:i.filter((ge,oe)=>oe!==t);w(y,n),r("remove",a,n)},ne=a=>{var t;if(u.value){if(a.preventDefault(),l.uniqueValue&&((t=v.value)!=null&&t.includes(u.value))){r("pressEnter",u.value,a);return}const n=v.value.concat(u.value);w(n,a),r("pressEnter",u.value,a),z.value.create||V("",a)}},V=(a,t)=>{N.value=a,r("update:inputValue",a),r("inputValueChange",a,t)},ue=()=>{for(let a=c.value.length-1;a>=0;a--)if(c.value[a].closable)return a;return-1},w=(a,t)=>{E.value=a,r("update:modelValue",a),r("change",a,t)},D=a=>{a>12?T.width=`${a}px`:T.width="12px"};return e.watch(u,a=>{o.value&&!d.value&&a!==o.value.value&&(o.value.value=a)}),e.onMounted(()=>{p.value&&D(p.value.offsetWidth)}),(a,t)=>(e.openBlock(),e.createElementBlock("div",e.mergeProps({class:Q.value,onMousedown:X},U.value),[e.createVNode(e.unref(ce.TuResizeObserver),{onResize:Y},{default:e.withCtx(()=>[e.createElementVNode("span",{ref_key:"mirrorRef",ref:p,class:e.normalizeClass(e.unref(s).e("mirror"))},e.toDisplayString(j.value),3)]),_:1}),e.unref(O).prefix?(e.openBlock(),e.createElementBlock("span",{key:0,class:e.normalizeClass(e.unref(s).e("prefix"))},[e.renderSlot(a.$slots,"prefix")],2)):e.createCommentVNode("",!0),e.createVNode(e.TransitionGroup,{tag:"span",name:"input-tag-zoom",class:e.normalizeClass(e.unref(s).e("inner"))},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(g.value,(n,y)=>(e.openBlock(),e.createBlock(e.unref(de.TuTag),e.mergeProps({closable:""},n.tagProps,{size:G.value,key:`tag-${n.value}`,class:e.unref(s).e("tag"),disabled:e.unref(f),onClose:i=>q(n.value,y,i)}),{default:e.withCtx(()=>{var i;return[e.createTextVNode(e.toDisplayString(((i=a.formatTag)==null?void 0:i.call(a,n.raw))??n.label),1)]}),_:2},1040,["size","class","disabled","onClose"]))),128)),e.createElementVNode("input",e.mergeProps({ref_key:"inputRef",ref:o,key:"input-tag-input"},W.value,{class:e.unref(s).e("input"),style:T,placeholder:g.value.length===0?l.placeholder:void 0,disabled:e.unref(f),readonly:l.readonly||l.disabledInput,onInput:Z,onKeydown:ee,onFocus:ae,onBlur:le,onCompositionstart:I,onCompositionupdate:I,onCompositionend:I}),null,16,ve)]),_:1},8,["class"]),H.value?(e.openBlock(),e.createBlock(e.unref(R.TuIcon),{key:1,class:e.normalizeClass(e.unref(s).em("icon","clear")),onClick:te},{default:e.withCtx(()=>[e.createVNode(e.unref(re.Close))]),_:1},8,["class"])):e.createCommentVNode("",!0),h.value&&S.value&&J.value?(e.openBlock(),e.createBlock(e.unref(R.TuIcon),{key:2,class:e.normalizeClass([e.unref(s).e("icon"),e.unref(s).e("validateIcon"),e.unref(s).is("loading",h.value==="validating")])},{default:e.withCtx(()=>[(e.openBlock(),e.createBlock(e.resolveDynamicComponent(S.value)))]),_:1},8,["class"])):e.createCommentVNode("",!0)],16))}});exports.default=me;
