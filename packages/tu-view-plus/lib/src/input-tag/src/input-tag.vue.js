"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),M=require("./input-tag.js"),F=require("@tu-view-plus/hooks"),R=require("@tu-view-plus/constants"),C=require("@tu-view-plus/utils"),de=require("@tu-view-plus/icons-vue"),pe=require("../../resize-observer/index.js"),ve=require("./utils.js");require("../../form/index.js");const fe=require("../../tag/index.js"),$=require("../../icon/index.js");require("../style/input-tag.css");const A=require("../../form/src/hooks/use-form-props.js"),me=require("../../form/src/hooks/use-form-item.js"),ge=["placeholder","disabled","readonly"],Ve=e.defineComponent({name:"TuInputTag",inheritAttrs:!1}),he=e.defineComponent({...Ve,props:M.inputTagProps,emits:M.inputTagEmits,setup(L,{emit:O}){const U={value:"value",label:"label",closable:"closable",tagProps:"tagProps"},t=L,r=O,N=e.useAttrs(),W=e.useSlots(),o=F.useNamespace("input-tag"),_=A.useFormSize(),p=A.useFormDisabled(),{form:b,formItem:T}=me.useFormItem(),k=e.reactive({width:"12px"}),v=e.ref(),s=e.ref(),c=e.ref(!1),I=e.ref(!1),g=e.ref(""),j=e.computed(()=>({...U,...t.fieldNames})),x=e.ref(!1),B=e.ref(t.defaultValue),z=e.ref(t.defaultInputValue),K=e.computed(()=>C.omit(N,R.INPUT_EVENTS)),G=e.computed(()=>C.pick(N,R.INPUT_EVENTS)),H=e.computed(()=>m.value.length>0?g.value||u.value:g.value||u.value||t.placeholder),f=e.computed(()=>t.modelValue??B.value),u=e.computed(()=>t.inputValue??z.value),d=e.computed(()=>ve.getValueData(f.value,j.value)),J=e.computed(()=>["small","mini"].indexOf(t.size)>-1?"mini":t.size==="large"?"medium":"small"),m=e.computed(()=>{if(t.maxTagCount>0){const a=d.value.length-t.maxTagCount;if(a>0){const l=d.value.slice(0,t.maxTagCount),n={value:"__tu__more",label:`${a}..`,closable:!1};return l.push({raw:n,...n}),l}}return d.value}),Q=e.computed(()=>!p.value&&!t.readonly&&t.allowClear&&!!f.value.length&&I.value),X=e.computed(()=>(b==null?void 0:b.statusIcon)??!1),V=e.computed(()=>(T==null?void 0:T.validateState)||""),S=e.computed(()=>C.isObject(t.retainInputValue)?{create:!1,blur:!1,...t.retainInputValue}:{create:t.retainInputValue,blur:t.retainInputValue}),q=e.computed(()=>V.value&&C.ValidateComponentsMap[V.value]),Y=e.computed(()=>({[o.b()]:!0,[o.m(_.value)]:_.value,[o.m("has-tag")]:m.value.length>0,[o.is("disabled")]:p.value})),Z=a=>{I.value=!0,r("mouseenter",a)},ee=a=>{I.value=!1,r("mouseleave",a)},ae=a=>{s.value&&a.target!==s.value&&(a.preventDefault(),s.value.focus())},le=()=>{v.value&&P(v.value.offsetWidth)},te=a=>{const{value:l}=a.target;c.value||(h(l,a),e.nextTick(()=>{s.value&&u.value!==s.value.value&&(s.value.value=u.value)}))},ne=a=>{const l=a.key||a.code;if(!c.value&&u.value&&l==="Enter"&&re(a),!c.value&&m.value.length>0&&!u.value&&l==="Backspace"){const n=ie();n>=0&&D(d.value[n].value,n,a)}},ue=a=>{x.value=!0,r("focus",a)},oe=a=>{x.value=!1,!S.value.blur&&u.value&&h("",a),r("blur",a)},w=a=>{const{value:l}=a.target;a.type==="compositionend"?(c.value=!1,g.value="",h(l,a),e.nextTick(()=>{s.value&&u.value!==s.value.value&&(s.value.value=u.value)})):(c.value=!0,g.value=u.value+(a.data??""))},se=a=>{y([],a),r("clear",a)},D=(a,l,n)=>{var i;const E=(i=f.value)==null?void 0:i.filter((Ce,ce)=>ce!==l);y(E,n),r("remove",a,n)},re=a=>{var l;if(u.value){if(a.preventDefault(),t.uniqueValue&&((l=f.value)!=null&&l.includes(u.value))){r("pressEnter",u.value,a);return}const n=f.value.concat(u.value);y(n,a),r("pressEnter",u.value,a),S.value.create||h("",a)}},h=(a,l)=>{z.value=a,r("update:inputValue",a),r("inputValueChange",a,l)},ie=()=>{for(let a=d.value.length-1;a>=0;a--)if(d.value[a].closable)return a;return-1},y=(a,l)=>{B.value=a,r("update:modelValue",a),r("change",a,l)},P=a=>{a>12?k.width=`${a}px`:k.width="12px"};return e.watch(u,a=>{s.value&&!c.value&&a!==s.value.value&&(s.value.value=a)}),e.onMounted(()=>{v.value&&P(v.value.offsetWidth)}),(a,l)=>(e.openBlock(),e.createElementBlock("div",e.mergeProps(K.value,{class:Y.value,onMousedown:ae,onMouseenter:Z,onMouseleave:ee}),[e.createVNode(e.unref(pe.TuResizeObserver),{onResize:le},{default:e.withCtx(()=>[e.createElementVNode("span",{ref_key:"mirrorRef",ref:v,class:e.normalizeClass(e.unref(o).e("mirror"))},e.toDisplayString(H.value),3)]),_:1}),e.unref(W).prefix?(e.openBlock(),e.createElementBlock("span",{key:0,class:e.normalizeClass(e.unref(o).e("prefix"))},[e.renderSlot(a.$slots,"prefix")],2)):e.createCommentVNode("",!0),e.createVNode(e.TransitionGroup,{tag:"span",name:`${e.unref(F.defaultNamespace)}-input-tag-zoom`,class:e.normalizeClass(e.unref(o).e("inner"))},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(m.value,(n,E)=>(e.openBlock(),e.createBlock(e.unref(fe.TuTag),e.mergeProps(n.tagProps,{disableTransitions:"",size:J.value,key:`tag-${n.value}`,class:e.unref(o).e("tag"),closable:!e.unref(p)&&!a.readonly&&n.closable,disabled:e.unref(p),onClose:i=>D(n.value,E,i)}),{default:e.withCtx(()=>{var i;return[e.createTextVNode(e.toDisplayString(((i=a.formatTag)==null?void 0:i.call(a,n.raw))??n.label),1)]}),_:2},1040,["size","class","closable","disabled","onClose"]))),128)),e.createElementVNode("input",e.mergeProps({ref_key:"inputRef",ref:s,key:"input-tag-input"},G.value,{class:e.unref(o).e("input"),style:k,placeholder:m.value.length===0?t.placeholder:void 0,disabled:e.unref(p),readonly:t.readonly||t.disabledInput,onInput:te,onKeydown:ne,onFocus:ue,onBlur:oe,onCompositionstart:w,onCompositionupdate:w,onCompositionend:w}),null,16,ge)]),_:1},8,["name","class"]),e.createElementVNode("span",{class:e.normalizeClass(e.unref(o).e("suffix"))},[Q.value?(e.openBlock(),e.createBlock(e.unref($.TuIcon),{key:0,class:e.normalizeClass([e.unref(o).e("icon"),e.unref(o).em("icon","clear")]),onClick:se,onMousedown:l[0]||(l[0]=n=>n.stopPropagation())},{default:e.withCtx(()=>[e.createVNode(e.unref(de.Close))]),_:1},8,["class"])):e.createCommentVNode("",!0),V.value&&q.value&&X.value?(e.openBlock(),e.createBlock(e.unref($.TuIcon),{key:1,class:e.normalizeClass([e.unref(o).e("icon"),e.unref(o).e("validateIcon"),e.unref(o).is("loading",V.value==="validating")])},{default:e.withCtx(()=>[(e.openBlock(),e.createBlock(e.resolveDynamicComponent(q.value)))]),_:1},8,["class"])):e.createCommentVNode("",!0)],2)],16))}});exports.default=he;
