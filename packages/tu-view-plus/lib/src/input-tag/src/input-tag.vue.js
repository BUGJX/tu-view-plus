"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),F=require("./input-tag.js"),R=require("@tu-view-plus/hooks"),$=require("@tu-view-plus/constants"),C=require("@tu-view-plus/utils"),de=require("@tu-view-plus/icons-vue"),pe=require("../../resize-observer/index.js"),fe=require("./utils.js");require("../../form/index.js");const ve=require("../../tag/index.js"),A=require("../../icon/index.js");require("../style/input-tag.css");const L=require("../../form/src/hooks/use-form-props.js"),me=require("../../form/src/hooks/use-form-item.js"),ge=["placeholder","disabled","readonly"],he=e.defineComponent({name:"TuInputTag"}),Ve=e.defineComponent({...he,props:F.inputTagProps,emits:F.inputTagEmits,setup(O,{emit:U}){const W={value:"value",label:"label",closable:"closable",tagProps:"tagProps"},t=O,r=U,E=e.useAttrs(),b=e.useSlots(),u=R.useNamespace("input-tag"),N=L.useFormSize(),p=L.useFormDisabled(),{form:T,formItem:k}=me.useFormItem(),I=e.reactive({width:"12px"}),f=e.ref(),s=e.ref(),c=e.ref(!1),w=e.ref(!1),g=e.ref(""),j=e.computed(()=>({...W,...t.fieldNames})),_=e.ref(!1),z=e.ref(t.defaultValue),S=e.ref(t.defaultInputValue),K=e.computed(()=>C.omit(E,$.INPUT_EVENTS)),G=e.computed(()=>C.pick(E,$.INPUT_EVENTS)),H=e.computed(()=>m.value.length>0?g.value||o.value:g.value||o.value||t.placeholder),v=e.computed(()=>t.modelValue??z.value),o=e.computed(()=>t.inputValue??S.value),d=e.computed(()=>fe.getValueData(v.value,j.value)),J=e.computed(()=>["small","mini"].indexOf(t.size)>-1?"mini":t.size==="large"?"medium":"small"),m=e.computed(()=>{if(t.maxTagCount>0){const a=d.value.length-t.maxTagCount;if(a>0){const l=d.value.slice(0,t.maxTagCount),n={value:"__tu__more",label:`${a}..`,closable:!1};return l.push({raw:n,...n}),l}}return d.value}),Q=e.computed(()=>!p.value&&!t.readonly&&t.allowClear&&!!v.value.length&&w.value),X=e.computed(()=>(T==null?void 0:T.statusIcon)??!1),h=e.computed(()=>(k==null?void 0:k.validateState)||""),q=e.computed(()=>C.isObject(t.retainInputValue)?{create:!1,blur:!1,...t.retainInputValue}:{create:t.retainInputValue,blur:t.retainInputValue}),D=e.computed(()=>h.value&&C.ValidateComponentsMap[h.value]),Y=e.computed(()=>({[u.b()]:!0,[u.m(N.value)]:N.value,[u.m("has-tag")]:m.value.length>0,[u.m("has-prefix")]:!!b.prefix,[u.m("has-suffix")]:!!b.suffix,[u.is("disabled")]:p.value})),Z=a=>{w.value=!0,r("mouseenter",a)},ee=a=>{w.value=!1,r("mouseleave",a)},ae=a=>{s.value&&a.target!==s.value&&(a.preventDefault(),s.value.focus())},le=()=>{f.value&&M(f.value.offsetWidth)},te=a=>{const{value:l}=a.target;c.value||(V(l,a),e.nextTick(()=>{s.value&&o.value!==s.value.value&&(s.value.value=o.value)}))},ne=a=>{const l=a.key||a.code;if(!c.value&&o.value&&l==="Enter"&&re(a),!c.value&&m.value.length>0&&!o.value&&l==="Backspace"){const n=ie();n>=0&&P(d.value[n].value,n,a)}},ue=a=>{_.value=!0,r("focus",a)},oe=a=>{_.value=!1,!q.value.blur&&o.value&&V("",a),r("blur",a)},y=a=>{const{value:l}=a.target;a.type==="compositionend"?(c.value=!1,g.value="",V(l,a),e.nextTick(()=>{s.value&&o.value!==s.value.value&&(s.value.value=o.value)})):(c.value=!0,g.value=o.value+(a.data??""))},se=a=>{x([],a),r("clear",a)},P=(a,l,n)=>{var i;const B=(i=v.value)==null?void 0:i.filter((Ce,ce)=>ce!==l);x(B,n),r("remove",a,n)},re=a=>{var l;if(o.value){if(a.preventDefault(),t.uniqueValue&&((l=v.value)!=null&&l.includes(o.value))){r("pressEnter",o.value,a);return}const n=v.value.concat(o.value);x(n,a),r("pressEnter",o.value,a),q.value.create||V("",a)}},V=(a,l)=>{S.value=a,r("update:inputValue",a),r("inputValueChange",a,l)},ie=()=>{for(let a=d.value.length-1;a>=0;a--)if(d.value[a].closable)return a;return-1},x=(a,l)=>{z.value=a,r("update:modelValue",a),r("change",a,l)},M=a=>{a>12?I.width=`${a}px`:I.width="12px"};return e.watch(o,a=>{s.value&&!c.value&&a!==s.value.value&&(s.value.value=a)}),e.onMounted(()=>{f.value&&M(f.value.offsetWidth)}),(a,l)=>(e.openBlock(),e.createElementBlock("div",e.mergeProps(K.value,{class:Y.value,onMousedown:ae,onMouseenter:Z,onMouseleave:ee}),[e.createVNode(e.unref(pe.TuResizeObserver),{onResize:le},{default:e.withCtx(()=>[e.createElementVNode("span",{ref_key:"mirrorRef",ref:f,class:e.normalizeClass(e.unref(u).e("mirror"))},e.toDisplayString(H.value),3)]),_:1}),e.unref(b).prefix?(e.openBlock(),e.createElementBlock("span",{key:0,class:e.normalizeClass(e.unref(u).e("prefix"))},[e.renderSlot(a.$slots,"prefix")],2)):e.createCommentVNode("",!0),e.createVNode(e.TransitionGroup,{tag:"span",name:`${e.unref(R.defaultNamespace)}-input-tag-zoom`,class:e.normalizeClass(e.unref(u).e("inner"))},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(m.value,(n,B)=>(e.openBlock(),e.createBlock(e.unref(ve.TuTag),e.mergeProps(n.tagProps,{disableTransitions:"",size:J.value,key:`tag-${n.value}`,class:e.unref(u).e("tag"),closable:!e.unref(p)&&!a.readonly&&n.closable,disabled:e.unref(p),onClose:i=>P(n.value,B,i)}),{default:e.withCtx(()=>{var i;return[e.createTextVNode(e.toDisplayString(((i=a.formatTag)==null?void 0:i.call(a,n.raw))??n.label),1)]}),_:2},1040,["size","class","closable","disabled","onClose"]))),128)),e.createElementVNode("input",e.mergeProps({ref_key:"inputRef",ref:s,key:"input-tag-input"},G.value,{class:e.unref(u).e("input"),style:I,placeholder:m.value.length===0?t.placeholder:void 0,disabled:e.unref(p),readonly:t.readonly||t.disabledInput,onInput:te,onKeydown:ne,onFocus:ue,onBlur:oe,onCompositionstart:y,onCompositionupdate:y,onCompositionend:y}),null,16,ge)]),_:1},8,["name","class"]),e.createElementVNode("span",{class:e.normalizeClass(e.unref(u).e("suffix"))},[Q.value?(e.openBlock(),e.createBlock(e.unref(A.TuIcon),{key:0,class:e.normalizeClass([e.unref(u).e("icon"),e.unref(u).em("icon","clear")]),onClick:se,onMousedown:l[0]||(l[0]=n=>n.stopPropagation())},{default:e.withCtx(()=>[e.createVNode(e.unref(de.Close))]),_:1},8,["class"])):e.createCommentVNode("",!0),h.value&&D.value&&X.value?(e.openBlock(),e.createBlock(e.unref(A.TuIcon),{key:1,class:e.normalizeClass([e.unref(u).e("icon"),e.unref(u).e("validateIcon"),e.unref(u).is("loading",h.value==="validating")])},{default:e.withCtx(()=>[(e.openBlock(),e.createBlock(e.resolveDynamicComponent(D.value)))]),_:1},8,["class"])):e.createCommentVNode("",!0)],2)],16))}});exports.default=Ve;
