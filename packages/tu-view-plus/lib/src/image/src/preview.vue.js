"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),L=require("./preview.js"),p=require("@tu-view-plus/hooks"),ue=require("../hooks/use-image-load-status.js"),me=require("../hooks/use-image-drag.js"),c=require("@tu-view-plus/utils"),y=require("../utils/get-scale.js"),N=require("../../icon/index.js"),u=require("@tu-view-plus/icons-vue"),de=require("./preview-toolbar.vue.js"),pe=require("./preview-arrow.vue.js"),ve=["src"],fe=e.defineComponent({name:"TuPreview"}),ge=e.defineComponent({...fe,props:L.previewProps,emits:L.previewEmits,setup(D,{emit:K}){const l=D,z=K,{t:m}=p.useLocale(),r=p.useNamespace("image"),{src:C,popupContainer:Y,visible:q,defaultVisible:M,maskClosable:W,actionsLayout:h,defaultScale:B,zoomRate:$}=e.toRefs(l),s=e.ref(),E=e.ref(),[i,F]=p.useMergeState(M.value,e.reactive({value:q})),G=e.computed(()=>({[r.e("preview")]:!0,[r.em("preview","hide")]:!i.value})),H=e.computed(()=>({[r.e("preview-img")]:!0,[r.em("preview-img","moving")]:Q.value})),v=p.usePopupContainer(document.body,e.reactive({popupContainer:Y})),Z=e.computed(()=>v.value===document.body),{zIndex:U}=p.usePopupManager("dialog",{visible:i}),j=e.computed(()=>({...Z.value?{zIndex:U.value,position:"fixed"}:{zIndex:"inherit",position:"absolute"}})),{isLoading:X,isLoaded:J,setLoadStatus:S}=ue.default(),d=e.ref(0),n=e.ref(B.value),{translate:O,moving:Q,resetTranslate:ee}=me.default(e.reactive({wrapperEl:s,imageEl:E,visible:i,scale:n})),g=e.ref(!1);let _=null;const te=()=>{!g.value&&(g.value=!0),_&&clearTimeout(_),_=setTimeout(()=>{g.value=!1},1e3)};p.usePopupOverflowHidden(e.reactive({container:v,hidden:i}));const oe=()=>{d.value=0,n.value=B.value,ee()},R=t=>h.value.includes(t),P=t=>{switch(t.stopPropagation(),t.preventDefault(),t.key){case c.KEYBOARD_KEY.ESC:l.escToClose&&b();break;case c.KEYBOARD_KEY.ARROW_LEFT:l.groupArrowProps.onPrev&&l.groupArrowProps.onPrev();break;case c.KEYBOARD_KEY.ARROW_RIGHT:l.groupArrowProps.onNext&&l.groupArrowProps.onNext();break;case c.KEYBOARD_KEY.ARROW_UP:R("zoomIn")&&w("zoomIn");break;case c.KEYBOARD_KEY.ARROW_DOWN:R("zoomOut")&&w("zoomOut");break;case c.KEYBOARD_KEY.SPACE:R("originalSize")&&f(1);break}},A=c.throttleByRaf(t=>{if(t.stopPropagation(),t.preventDefault(),!l.wheelZoom)return;const a=(t.deltaY||t.deltaX)>0?"zoomOut":"zoomIn",T=y.getScaleByRate(n.value,$.value,a);f(T)});let k=!1;const ne=()=>{e.nextTick(()=>{var t;(t=s==null?void 0:s.value)==null||t.focus()}),l.keyboard&&!k&&(k=!0,c.on(v.value,"keydown",P))},V=()=>{k&&(k=!1,c.off(v.value,"keydown",P))};e.watch([C,i],()=>{i.value?(oe(),S("loading"),ne()):V()});const b=()=>{i.value&&(z("close"),z("update:visible",!1),F(!1))},ae=()=>{b()},I=t=>{var o;(o=s==null?void 0:s.value)==null||o.focus(),W.value&&t.target===t.currentTarget&&b()},f=t=>{n.value!==t&&(n.value=t,te())},le=()=>{const t=s.value.getBoundingClientRect(),o=E.value.getBoundingClientRect(),a=t.height/(o.height/n.value),T=t.width/(o.width/n.value),ce=Math.max(a,T);f(ce)},x=t=>{const a=t==="clockwise"?(d.value+90)%360:d.value===0?360-90:d.value-90;d.value=a},w=t=>{const o=y.default(n.value,t);f(o)},re=()=>{S("loaded")},se=()=>{S("error")},ie=e.computed(()=>[{key:"fullScreen",name:m("tu.image.fullScreen"),content:()=>e.h(u.FullScreen),onClick:()=>le()},{key:"rotateRight",name:m("tu.image.rotateRight"),content:()=>e.h(u.RefreshRight),onClick:()=>x("clockwise")},{key:"rotateLeft",name:m("tu.image.rotateLeft"),content:()=>e.h(u.RefreshLeft),onClick:()=>x("counterclockwise")},{key:"zoomIn",name:m("tu.image.zoomIn"),content:()=>e.h(u.ZoomIn),onClick:()=>w("zoomIn"),disabled:n.value===y.maxScale},{key:"zoomOut",name:m("tu.image.zoomOut"),content:()=>e.h(u.ZoomOut),onClick:()=>w("zoomOut"),disabled:n.value===y.minScale},{key:"originalSize",name:m("tu.image.originalSize"),content:()=>e.h(u.Refresh),onClick:()=>f(1)}]);return e.onBeforeUnmount(()=>{V()}),(t,o)=>(e.openBlock(),e.createBlock(e.Teleport,{to:e.unref(v),disabled:!l.renderToBody},[e.createElementVNode("div",{class:e.normalizeClass(G.value),style:e.normalizeStyle(j.value)},[e.createVNode(e.Transition,{name:"image-fade",onBeforeEnter:o[0]||(o[0]=a=>a.parentElement&&(a.parentElement.style.display="block")),onAfterLeave:o[1]||(o[1]=a=>a.parentElement&&(a.parentElement.style.display=""))},{default:e.withCtx(()=>[e.withDirectives(e.createElementVNode("div",{class:e.normalizeClass(e.unref(r).e("preview-mask"))},null,2),[[e.vShow,e.unref(i)]])]),_:1}),e.unref(i)?(e.openBlock(),e.createElementBlock("div",{key:0,ref_key:"refWrapper",ref:s,tabindex:"0",class:e.normalizeClass(e.unref(r).e("preview-wrapper")),onClick:I,onWheel:o[2]||(o[2]=e.withModifiers((...a)=>e.unref(A)&&e.unref(A)(...a),["prevent","stop"]))},[e.createElementVNode("div",{class:e.normalizeClass(e.unref(r).e("preview-img-container")),style:e.normalizeStyle({transform:`scale(${n.value},${n.value})`}),onClick:I},[(e.openBlock(),e.createElementBlock("img",{ref_key:"refImage",ref:E,key:e.unref(C),src:e.unref(C),class:e.normalizeClass(H.value),style:e.normalizeStyle({transform:`translate(${e.unref(O)[0]}px, ${e.unref(O)[1]}px) rotate(${d.value}deg)`}),onLoad:re,onError:se},null,46,ve))],6),e.unref(X)?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(r).e("preview-loading"))},[e.createVNode(e.unref(N.TuIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(u.Loading))]),_:1})],2)):e.createCommentVNode("",!0),e.createVNode(e.Transition,{name:"image-fade"},{default:e.withCtx(()=>[g.value?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(r).e("preview-scale-value"))},e.toDisplayString((n.value*100).toFixed(0))+"% ",3)):e.createCommentVNode("",!0)]),_:1}),e.unref(J)&&e.unref(h).length?(e.openBlock(),e.createBlock(de.default,{key:1,actions:ie.value,"actions-layout":e.unref(h)},{default:e.withCtx(()=>[e.renderSlot(t.$slots,"actions")]),_:3},8,["actions","actions-layout"])):e.createCommentVNode("",!0),t.closable?(e.openBlock(),e.createElementBlock("div",{key:2,class:e.normalizeClass(e.unref(r).e("preview-close-btn")),onClick:ae},[e.createVNode(e.unref(N.TuIcon),null,{default:e.withCtx(()=>[e.createVNode(e.unref(u.Close))]),_:1})],2)):e.createCommentVNode("",!0),l.inGroup?(e.openBlock(),e.createBlock(pe.default,e.normalizeProps(e.mergeProps({key:3},l.groupArrowProps)),null,16)):e.createCommentVNode("",!0)],34)):e.createCommentVNode("",!0)],6)],8,["to","disabled"]))}});exports.default=ge;
