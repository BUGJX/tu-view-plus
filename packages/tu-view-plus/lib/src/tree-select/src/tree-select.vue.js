"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),M=require("./tree-select.js"),D=require("@tu-view-plus/hooks"),m=require("@tu-view-plus/utils");require("../../form/index.js");const ce=require("./hooks/use-filter-tree-node.js"),de=require("./hooks/use-selected-state.js"),I=require("../../tree/src/utils/check-utils.js"),pe=require("../../tree/src/hooks/use-tree-data.js"),fe=require("../../tree/src/utils/index.js"),ve=require("../../trigger/index.js"),me=require("../../spin/index.js"),he=require("../../empty/index.js"),Se=require("../../select-view/index.js"),be=require("./tree-select-dropdown.vue.js");require("../style/tree-select.css");const K=require("../../form/src/hooks/use-form-props.js"),ke=e.defineComponent({name:"TuTreeSelect",inheritAttrs:!1}),ge=e.defineComponent({...ke,props:M.treeSelectProps,emits:M.treeSelectEmits,setup(O,{emit:R}){const h=O,s=R,$=e.useSlots(),{defaultValue:L,modelValue:j,multiple:S,popupVisible:U,defaultPopupVisible:A,treeCheckable:n,treeCheckStrictly:b,data:z,fieldNames:i,labelInValue:H,filterTreeNode:G,disableFilter:J,dropdownStyle:k,treeProps:c,fallbackOption:Q,selectable:u,dropdownClassName:g}=e.toRefs(h),d=e.ref(),o=e.ref(""),a=D.useNamespace("tree-select"),B=K.useFormSize(),p=K.useFormDisabled(),[y,W]=D.useMergeState(A.value,e.reactive({value:U})),C=(l,t)=>u.value==="leaf"?t.isLeaf:m.isFunction(u.value)?u.value(l,t):u.value??!1,P=e.computed(()=>n.value?C:!1),{flattenTreeData:E,key2TreeNode:V}=pe.useTreeData(e.reactive({treeData:z,fieldNames:i,selectable:C,checkable:P})),{isEmptyFilterResult:X,filterTreeNode:Y}=ce.useFilterTreeNode(e.reactive({searchValue:o,flattenTreeData:E,filterMethod:G,disableFilter:J,fieldNames:i})),{selectedKeys:w,selectedValue:T,setLocalSelectedKeys:Z,localSelectedKeys:x,localSelectedValue:_}=de.useSelectedState(e.reactive({defaultValue:L,modelValue:j,key2TreeNode:V,multiple:S,treeCheckable:n,treeCheckStrictly:b,fallbackOption:Q,fieldNames:i})),f=e.computed(()=>S.value||n.value),ee=e.computed(()=>m.isUndefined(T.value)?[]:f.value&&!p.value?T.value.map(l=>{const t=V.value.get(l.value);return{...l,closable:!t||F(t)}}):T.value),le=e.computed(()=>[a.e("dropdown"),{[a.em("dropdown","has-header")]:!!$.header,[a.em("dropdown","has-footer")]:!!$.footer},g==null?void 0:g.value]),te=e.computed(()=>{var l;return[(k==null?void 0:k.value)||{},(l=c==null?void 0:c.value)!=null&&l.virtualListProps?{"max-height":"unset"}:{}]}),N=e.computed(()=>!E.value.length||X.value),oe=e.computed(()=>m.isObject(h.allowSearch)&&!!h.allowSearch.retainInputValue),F=l=>n.value?I.isNodeCheckable(l):fe.isNodeSelectable(l),q=l=>{l!==y.value&&(W(l),s("popup-visible-change",l),s("update:popupVisible",l)),l||d.value&&d.value.blur&&d.value.blur()},v=l=>{Z(l),e.nextTick(()=>{const t=(H.value?_.value:x.value)||[],r=f.value?t:t[0];s("update:modelValue",r),s("change",r)})},re=l=>{l!==o.value&&(q(!0),o.value=l,s("search",l))},ae=()=>{v([]),s("clear")},se=l=>{if(p.value)return;const t=V.value.get(l);if(n.value&&t){if(F(t)){const[r]=I.getCheckedStateByCheck({node:t,checked:!1,checkedKeys:w.value,indeterminateKeys:[],checkStrictly:b.value});v(r)}}else{const r=w.value.filter(ie=>ie!==l);v(r)}},ne=()=>{!oe.value&&o.value&&(o.value="")},ue=l=>{v(l),o.value="",f.value||q(!1)};return(l,t)=>(e.openBlock(),e.createBlock(e.unref(ve.TuTrigger),e.mergeProps(l.triggerProps,{"auto-fit-transform-origin":"","auto-fit-popup-min-width":"",trigger:"click",position:"bl","animation-name":"slide-dynamic-origin",class:e.unref(a).b(),"popup-offset":10,"prevent-focus":!0,disabled:e.unref(p),"popup-visible":e.unref(y),"popup-container":l.popupContainer,"click-to-close":!l.allowSearch,onPopupVisibleChange:q}),{content:e.withCtx(()=>[e.createElementVNode("div",{class:e.normalizeClass(le.value),style:e.normalizeStyle(te.value)},[l.$slots.header&&(!N.value||l.showHeaderOnEmpty)?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(a).em("dropdown","header"))},[e.renderSlot(l.$slots,"header")],2)):e.createCommentVNode("",!0),l.loading?e.renderSlot(l.$slots,"loader",{key:1},()=>[e.createVNode(e.unref(me.TuSpin),{dot:"",loading:"",class:e.normalizeClass(e.unref(a).e("dropdown-loading"))},null,8,["class"])]):N.value?e.renderSlot(l.$slots,"empty",{key:2},()=>[e.createVNode(e.unref(he.TuEmpty))]):(e.openBlock(),e.createBlock(be.default,{key:3,"selected-keys":e.unref(w),"show-checkable":e.unref(n),scrollbar:l.scrollbar,size:e.unref(B),"tree-props":{actionOnNodeClick:e.unref(u)==="leaf"?"expand":void 0,blockNode:!0,data:e.unref(z),checkStrictly:e.unref(b),checkedStrategy:l.treeCheckedStrategy,fieldNames:e.unref(i),multiple:e.unref(S),loadMore:l.loadMore,filterTreeNode:e.unref(Y),size:l.size,checkable:P.value,selectable:C,searchValue:o.value,...e.unref(c)},"tree-slots":e.unref(m.pickSubCompSlots)(l.$slots,"tree"),onChange:ue},null,8,["selected-keys","show-checkable","scrollbar","size","tree-props","tree-slots"])),l.$slots.footer&&(!N.value||l.showFooterOnEmpty)?(e.openBlock(),e.createElementBlock("div",{key:4,class:e.normalizeClass(e.unref(a).em("dropdown","footer"))},[e.renderSlot(l.$slots,"footer")],2)):e.createCommentVNode("",!0)],6)]),default:e.withCtx(()=>[e.renderSlot(l.$slots,"trigger",{},()=>[e.createVNode(e.unref(Se.TuSelectView),e.mergeProps({ref_key:"refSelectView",ref:d,"model-value":ee.value,"input-value":o.value,"allow-search":!!l.allowSearch,"allow-clear":l.allowClear,loading:l.loading,size:e.unref(B),"max-tag-count":l.maxTagCount,disabled:e.unref(p),opened:e.unref(y),error:l.error,bordered:l.border,placeholder:l.placeholder,multiple:f.value},l.$attrs,{onInputValueChange:re,onClear:e.withModifiers(ae,["stop"]),onRemove:se,onBlur:ne}),e.createSlots({_:2},[l.$slots.prefix?{name:"prefix",fn:e.withCtx(()=>[e.renderSlot(l.$slots,"prefix")]),key:"0"}:void 0,l.$slots.label?{name:"label",fn:e.withCtx(r=>[e.renderSlot(l.$slots,"label",e.normalizeProps(e.guardReactiveProps(r)))]),key:"1"}:void 0]),1040,["model-value","input-value","allow-search","allow-clear","loading","size","max-tag-count","disabled","opened","error","bordered","placeholder","multiple"])])]),_:3},16,["class","disabled","popup-visible","popup-container","click-to-close"]))}});exports.default=ge;
